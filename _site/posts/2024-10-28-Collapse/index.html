<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.39">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<meta name="author" content="Hojun LEE">
<meta name="dcterms.date" content="2024-10-29">
<meta name="description" content="collapse; fast, flexible, parsimonoius code package for R.">
<title>collapse 패키지 소개 v2 – 차라투 블로그</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../img/logo_favicon.png" rel="icon" type="image/png">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-0626ff4d7a71b55c8707dcae1d04a9b6.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-2fa66d5285053e3ebee39b9a5638a87d.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><script type="text/javascript">

(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-135478021-2', 'auto');

ga('send', {
  hitType: 'pageview',
  'anonymizeIp': true,
});
</script><style>html{ scroll-behavior: smooth; }</style>
<link rel="stylesheet" href="../../styles.css">
</head>
<body class="floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner"><nav class="navbar navbar-expand-lg " data-bs-theme="dark"><div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../../img/logo.png" alt="" class="navbar-logo"></a>
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">차라투 블로그</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
<li class="nav-item">
    <a class="nav-link" href="../../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://openstat.ai/" target="_blank"> 
<span class="menu-text">Applications</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-r-packages" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">R packages</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-r-packages">
<li>
    <a class="dropdown-item" href="https://jinseob2kim.github.io/jstable/" target="_blank">
 <span class="dropdown-text">jstable</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://jinseob2kim.github.io/jskm/" target="_blank">
 <span class="dropdown-text">jskm</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://jinseob2kim.github.io/jsmodule/" target="_blank">
 <span class="dropdown-text">jsmodule</span></a>
  </li>  
    </ul>
</li>
  <li class="nav-item">
    <a class="nav-link" href="../../contributors.html"> 
<span class="menu-text">Contributors</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-partners" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Partners</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-partners">
<li>
    <a class="dropdown-item" href="https://www.r-bloggers.com/" target="_blank">
 <span class="dropdown-text"><img src="https://www.r-bloggers.com/favicon.ico"> R-bloggers</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://github.com/shinykorea/" target="_blank">
 <span class="dropdown-text"><img width="16px" src="https://avatars.githubusercontent.com/u/46996346?s=200&amp;v=4"> Shinykorea</span></a>
  </li>  
    </ul>
</li>
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/zarathucorp" target="_blank"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/company/zarathu/" target="_blank"> <i class="bi bi-linkedin" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="../../index.xml" target="_blank"> <i class="bi bi-rss" role="img" aria-label="RSS">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-bi-translate" role="link" data-bs-toggle="dropdown" aria-expanded="false">
      <i class="bi bi-translate" role="img">
</i> 
 <span class="menu-text"></span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-bi-translate">
<li>
    <a class="dropdown-item" href="../../../index.html">
 <span class="dropdown-text">한국어</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../en/index.html">
 <span class="dropdown-text">English</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../jp/index.html">
 <span class="dropdown-text">日本語</span></a>
  </li>  
    </ul>
</li>
</ul>
</div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav></header><!-- content --><header id="title-block-header" class="quarto-title-block default toc-left page-columns page-full"><div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">collapse 패키지 소개 v2</h1>
                  <div>
        <div class="description">
          <p>collapse; fast, flexible, parsimonoius code package for R.</p>
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">R</div>
                <div class="quarto-category">statistics</div>
                <div class="quarto-category">data.table</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p><a href="https://github.com/21-HJ">Hojun LEE</a> </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">October 29, 2024</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto"><nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">On this page</h2>
   
  <ul>
<li>
<a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a>
  <ul class="collapse">
<li><a href="#setup" id="toc-setup" class="nav-link" data-scroll-target="#setup">Setup</a></li>
  <li><a href="#basic" id="toc-basic" class="nav-link" data-scroll-target="#basic">Basic</a></li>
  </ul>
</li>
  <li>
<a href="#collapse-package" id="toc-collapse-package" class="nav-link" data-scroll-target="#collapse-package">Collapse package</a>
  <ul class="collapse">
<li><a href="#fast-statistical-function" id="toc-fast-statistical-function" class="nav-link" data-scroll-target="#fast-statistical-function">Fast Statistical Function</a></li>
  <li><a href="#consideration-w-missing-data-%EA%B2%B0%EC%B8%A1%EC%B9%98-%EC%B2%98%EB%A6%AC" id="toc-consideration-w-missing-data-결측치-처리" class="nav-link" data-scroll-target="#consideration-w-missing-data-%EA%B2%B0%EC%B8%A1%EC%B9%98-%EC%B2%98%EB%A6%AC">Consideration w/ missing data: 결측치 처리</a></li>
  <li><a href="#tra-function" id="toc-tra-function" class="nav-link" data-scroll-target="#tra-function">TRA function</a></li>
  <li><a href="#grouping-object" id="toc-grouping-object" class="nav-link" data-scroll-target="#grouping-object">Grouping Object</a></li>
  <li><a href="#factors-in-operation" id="toc-factors-in-operation" class="nav-link" data-scroll-target="#factors-in-operation">Factors in operation</a></li>
  <li><a href="#summary-fast-grouping-and-ordering" id="toc-summary-fast-grouping-and-ordering" class="nav-link" data-scroll-target="#summary-fast-grouping-and-ordering">Summary: FAST grouping and Ordering</a></li>
  <li><a href="#collapse%EB%8A%94-%EB%B9%A0%EB%A5%B4%EB%8B%A4" id="toc-collapse는-빠르다" class="nav-link" data-scroll-target="#collapse%EB%8A%94-%EB%B9%A0%EB%A5%B4%EB%8B%A4">Collapse는 빠르다!</a></li>
  <li><a href="#collapse-w-fast-statistical-function-%EB%8B%A4%EC%96%91%ED%95%9C-%ED%99%9C%EC%9A%A9" id="toc-collapse-w-fast-statistical-function-다양한-활용" class="nav-link" data-scroll-target="#collapse-w-fast-statistical-function-%EB%8B%A4%EC%96%91%ED%95%9C-%ED%99%9C%EC%9A%A9">Collapse w/ Fast Statistical Function: 다양한 활용</a></li>
  <li><a href="#%EC%9D%B4%EB%A6%84%EC%88%9C%EB%B2%88vectors%EC%A0%95%EA%B7%9C%ED%91%9C%ED%98%84%EC%8B%9D%EC%9C%BC%EB%A1%9C-%ED%96%89%EC%97%B4%EC%9D%84-%EC%A7%80%EC%B9%AD%ED%95%A0-%EC%88%98-%EC%9E%88%EB%8B%A4." id="toc-이름순번vectors정규표현식으로-행열을-지칭할-수-있다." class="nav-link" data-scroll-target="#%EC%9D%B4%EB%A6%84%EC%88%9C%EB%B2%88vectors%EC%A0%95%EA%B7%9C%ED%91%9C%ED%98%84%EC%8B%9D%EC%9C%BC%EB%A1%9C-%ED%96%89%EC%97%B4%EC%9D%84-%EC%A7%80%EC%B9%AD%ED%95%A0-%EC%88%98-%EC%9E%88%EB%8B%A4.">이름/순번/vectors/정규표현식으로 행/열을 지칭할 수 있다.</a></li>
  <li><a href="#efficient-programming" id="toc-efficient-programming" class="nav-link" data-scroll-target="#efficient-programming">Efficient programming</a></li>
  </ul>
</li>
  <li><a href="#collapse-and-data.table" id="toc-collapse-and-data.table" class="nav-link" data-scroll-target="#collapse-and-data.table">Collapse and data.table</a></li>
  <li><a href="#summary" id="toc-summary" class="nav-link" data-scroll-target="#summary">Summary</a></li>
  </ul></nav>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content"><!-- Google tag (gtag.js) --><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-L0DYYSH9KM"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-L0DYYSH9KM');
</script><pre><code></code></pre>
<section id="introduction" class="level1"><h1>Introduction</h1>
<ul>
<li>
<strong>Collapse</strong>
<ol type="1">
<li><p>C/C++ 기반의 패키지로 큰 데이터셋을 보다 쉽게 다룰 수 있도록 구성됨.</p></li>
<li><p>R code의 성능을 획기적으로 개선하여 대규모 데이터를 <strong>빠르고 효율적</strong>으로 처리함을 목표로 함.</p></li>
<li><p>성능을 극대화함과 동시에, 기존 데이터 조작 framework와 통합할 수 있도록 안정적이고 최적화된 사용자 API를 제공함. (dplyr, tidyverse, data.table 등)</p></li>
</ol>
</li>
<li>
<strong>MAIN FOCUS</strong> -&gt; <strong>data.table</strong>과 함께 이용하여 보다 빠르게 연산을 처리하자.</li>
</ul>
<section id="setup" class="level2"><h2 class="anchored" data-anchor-id="setup">Setup</h2>
<div class="cell">
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">##setup</span></span>
<span></span>
<span><span class="co">#install.packages("collapse")</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://magrittr.tidyverse.org">magrittr</a></span><span class="op">)</span>;<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span>;<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com">data.table</a></span><span class="op">)</span> </span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://sebkrantz.github.io/collapse/">collapse</a></span><span class="op">)</span>;<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/joshuaulrich/microbenchmark/">microbenchmark</a></span><span class="op">)</span>;<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">lmtest</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="basic" class="level2"><h2 class="anchored" data-anchor-id="basic">Basic</h2>
<p>data.table처럼 fread &amp; fwrite를 이용하여 csv파일을 처리한다.</p>
<div class="cell">
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Exam data: 09-15</span></span>
<span></span>
<span><span class="va">dt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/fread.html">fread</a></span><span class="op">(</span><span class="st">"https://raw.githubusercontent.com/jinseob2kim/lecture-snuhlab/master/data/example_g1e.csv"</span><span class="op">)</span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.csv</a></span><span class="op">(</span><span class="st">"https://raw.githubusercontent.com/jinseob2kim/lecture-snuhlab/master/data/example_g1e.csv"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/fwrite.html">fwrite</a></span><span class="op">(</span><span class="va">dt</span>, <span class="st">"aa.csv"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>Columns</strong>: <strong>‘fselect’</strong>로 원하는 열을 불러올 수 있다.</p>
<div class="cell">
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">fselect</span><span class="op">(</span><span class="va">dt</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, <span class="fl">13</span><span class="op">:</span><span class="fl">16</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   EXMD_BZ_YYYY RN_INDI HME_YYYYMM  HGHT  WGHT  WSTC   BMI
          &lt;int&gt;   &lt;int&gt;      &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;num&gt;
1:         2009  562083     200909   144    61    90  29.4
2:         2009  334536     200911   162    51    63  19.4
3:         2009  911867     200903   163    65    82  24.5
4:         2009  183321     200908   152    51    70  22.1
5:         2009  942671     200909   159    50    73  19.8
6:         2009  979358     200912   157    55    73  22.3</code></pre>
</div>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">fselect</span><span class="op">(</span><span class="va">dt</span>, <span class="va">EXMD_BZ_YYYY</span>,<span class="va">RN_INDI</span>,<span class="va">HME_YYYYMM</span> <span class="op">)</span><span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="op">)</span> <span class="co"># fselect(dt, "EXMD_BZ_YYYY","RN_INDI","HME_YYYYMM" )</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   EXMD_BZ_YYYY RN_INDI HME_YYYYMM
          &lt;int&gt;   &lt;int&gt;      &lt;int&gt;
1:         2009  562083     200909
2:         2009  334536     200911
3:         2009  911867     200903
4:         2009  183321     200908
5:         2009  942671     200909
6:         2009  979358     200912</code></pre>
</div>
</div>
<p><strong>Rows</strong>: <strong>‘fsubset()’</strong>로 원하는 행/열을 불러올 수 있다.</p>
<div class="cell">
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">fsubset</span><span class="op">(</span><span class="va">dt</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   EXMD_BZ_YYYY RN_INDI HME_YYYYMM Q_PHX_DX_STK Q_PHX_DX_HTDZ Q_PHX_DX_HTN
          &lt;int&gt;   &lt;int&gt;      &lt;int&gt;        &lt;int&gt;         &lt;int&gt;        &lt;int&gt;
1:         2009  562083     200909            0             0            1
2:         2009  334536     200911            0             0            0
3:         2009  911867     200903            0             0            0
   Q_PHX_DX_DM Q_PHX_DX_DLD Q_PHX_DX_PTB Q_HBV_AG Q_SMK_YN Q_DRK_FRQ_V09N  HGHT
         &lt;int&gt;        &lt;int&gt;        &lt;int&gt;    &lt;int&gt;    &lt;int&gt;          &lt;int&gt; &lt;int&gt;
1:           0            0           NA        3        1              0   144
2:           0            0           NA        2        1              0   162
3:           0            0           NA        3        1              0   163
    WGHT  WSTC   BMI VA_LT VA_RT BP_SYS BP_DIA URN_PROT   HGB   FBS TOT_CHOL
   &lt;int&gt; &lt;int&gt; &lt;num&gt; &lt;num&gt; &lt;num&gt;  &lt;int&gt;  &lt;int&gt;    &lt;int&gt; &lt;num&gt; &lt;int&gt;    &lt;int&gt;
1:    61    90  29.4   0.7   0.8    120     80        1  12.6   117      264
2:    51    63  19.4   0.8   1.0    120     80        1  13.8    96      169
3:    65    82  24.5   0.7   0.6    130     80        1  15.0   118      216
      TG   HDL   LDL  CRTN  SGOT  SGPT   GGT   GFR
   &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;num&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt;
1:   128    60   179   0.9    25    20    25    59
2:    92    70    80   0.9    18    15    28    74
3:   132    55   134   0.8    26    30    30    79</code></pre>
</div>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#fsubset(dt, c(1:3, 13:16)) #rows</span></span>
<span><span class="fu">fsubset</span><span class="op">(</span><span class="va">dt</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, <span class="fl">13</span><span class="op">:</span><span class="fl">16</span><span class="op">)</span>  <span class="co">#(dt, row, col)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    HGHT  WGHT  WSTC   BMI
   &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;num&gt;
1:   144    61    90  29.4
2:   162    51    63  19.4
3:   163    65    82  24.5</code></pre>
</div>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">fsubset</span><span class="op">(</span><span class="va">dt</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">dt</span><span class="op">)</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, <span class="fl">13</span><span class="op">:</span><span class="fl">16</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="op">)</span> <span class="co">#cols</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   EXMD_BZ_YYYY RN_INDI HME_YYYYMM  HGHT  WGHT  WSTC   BMI
          &lt;int&gt;   &lt;int&gt;      &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;num&gt;
1:         2009  562083     200909   144    61    90  29.4
2:         2009  334536     200911   162    51    63  19.4
3:         2009  911867     200903   163    65    82  24.5
4:         2009  183321     200908   152    51    70  22.1
5:         2009  942671     200909   159    50    73  19.8
6:         2009  979358     200912   157    55    73  22.3</code></pre>
</div>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># fsubset(dt, EXMD_BZ_YYYY %in% 2009:2012 &amp; BMI &gt;= 25) %&gt;%  fsubset(c(1:3),c(1:3,13:16))</span></span>
<span><span class="fu">fsubset</span><span class="op">(</span><span class="va">dt</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">dt</span><span class="op">)</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, <span class="fl">13</span><span class="op">:</span><span class="fl">16</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu">fsubset</span><span class="op">(</span><span class="va">EXMD_BZ_YYYY</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fl">2009</span><span class="op">:</span><span class="fl">2012</span> <span class="op">&amp;</span> <span class="va">BMI</span> <span class="op">&gt;=</span> <span class="fl">25</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="op">)</span> <span class="co"># same</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   EXMD_BZ_YYYY RN_INDI HME_YYYYMM  HGHT  WGHT  WSTC   BMI
          &lt;int&gt;   &lt;int&gt;      &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;num&gt;
1:         2009  562083     200909   144    61    90  29.4
2:         2009  318669     200904   155    66    78  27.5
3:         2009  668438     200904   160    71    94  27.7
4:         2009  560878     200903   144    58    93  28.0
5:         2009  375694     200906   151    70    94  30.7
6:         2009  446652     200909   158    64    80  25.6</code></pre>
</div>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">roworder</span><span class="op">(</span><span class="va">dt</span>, <span class="va">HGHT</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu">fsubset</span><span class="op">(</span><span class="va">EXMD_BZ_YYYY</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fl">2009</span><span class="op">:</span><span class="fl">2012</span> <span class="op">&amp;</span> <span class="va">BMI</span> <span class="op">&gt;=</span> <span class="fl">25</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">fsubset</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">dt</span><span class="op">)</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>,<span class="fl">13</span><span class="op">:</span><span class="fl">16</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   EXMD_BZ_YYYY RN_INDI HME_YYYYMM  HGHT  WGHT  WSTC   BMI
          &lt;int&gt;   &lt;int&gt;      &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;num&gt;
1:         2009  562083     200909   144    61    90  29.4
2:         2009  560878     200903   144    58    93  28.0
3:         2011  562083     201111   144    59    88  28.5
4:         2011  519824     201109   145    58    79  27.6
5:         2011  914987     201103   145    70    95  33.3
6:         2012  560878     201208   145    59    85  28.1</code></pre>
</div>
</div>
</section></section><section id="collapse-package" class="level1"><h1>Collapse package</h1>
<p>지금까지 collapse에서의 행/열 처리에 대해 알아보았다. 다음은 collapse에서 보다 빠른 연산 및 데이터 처리를 도와주는 도구들이다.</p>
<section id="fast-statistical-function" class="level2"><h2 class="anchored" data-anchor-id="fast-statistical-function">Fast Statistical Function</h2>
<div class="cell">
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">.FAST_STAT_FUN</span></span>
<span> <span class="co"># [1]  "fmean"      "fmedian"    "fmode"      "fsum"       "fprod"      </span></span>
<span> <span class="co"># [6]  "fsd"        "fvar"       "fmin"       "fmax"       "fnth"       </span></span>
<span> <span class="co"># [11] "ffirst"     "flast"      "fnobs"      "fndistinct"</span></span>
<span></span>
<span><span class="co"># 데이터 구조에 구애받지않음.</span></span>
<span><span class="va">v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span>,<span class="fl">3</span>,<span class="fl">4</span><span class="op">)</span></span>
<span><span class="va">m1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">50</span>, nrow <span class="op">=</span> <span class="fl">10</span>, ncol <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span> </span>
<span><span class="fu">fmean</span><span class="op">(</span><span class="va">v1</span><span class="op">)</span>; <span class="fu">fmean</span><span class="op">(</span><span class="va">m1</span><span class="op">)</span>; <span class="fu">fmean</span><span class="op">(</span><span class="va">dt</span><span class="op">)</span></span>
<span><span class="fu">fmode</span><span class="op">(</span><span class="va">v1</span><span class="op">)</span>; <span class="fu">fmode</span><span class="op">(</span><span class="va">m1</span><span class="op">)</span>; <span class="fu">fmode</span><span class="op">(</span><span class="va">dt</span><span class="op">)</span></span>
<span><span class="co"># fmean(m1): by columns</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># collapse; baseR과 비교했을 때 보다 빠른 속도를 보인다.</span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">1e7</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, <span class="fu">fmean</span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, <span class="fu">fmean</span><span class="op">(</span><span class="va">x</span>, nthreads <span class="op">=</span> <span class="fl">4</span><span class="op">)</span><span class="op">)</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Unit: milliseconds
                   expr       min        lq      mean    median        uq
                mean(x) 23.761096 23.786943 23.802908 23.799427 23.815928
               fmean(x) 15.332085 15.367978 15.388554 15.387914 15.404170
 fmean(x, nthreads = 4)  4.217606  6.684896  7.634676  7.741456  8.499509
      max neval cld
 23.94914   100 a  
 15.57999   100  b 
 11.20740   100   c</code></pre>
</div>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html">colMeans</a></span><span class="op">(</span><span class="va">dt</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="va">dt</span>, <span class="va">mean</span><span class="op">)</span>, <span class="fu">fmean</span><span class="op">(</span><span class="va">dt</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Unit: microseconds
             expr      min       lq       mean   median        uq      max
     colMeans(dt) 3154.750 3302.700 3300.31781 3307.968 3312.7130 3641.641
 sapply(dt, mean)  190.076  199.417  208.52219  206.010  215.9145  318.417
        fmean(dt)   52.889   53.803   56.23603   55.644   56.8805   90.947
 neval cld
   100 a  
   100  b 
   100   c</code></pre>
</div>
</div>
<ul>
<li>Data size가 더 클 경우, 보다 유용하다. <em>(GGDC10S: 5000rows, 11cols, ~10% missing values)</em>
</li>
</ul>
<div class="cell">
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span>base <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="va">GGDC10S</span><span class="op">[</span><span class="fl">6</span><span class="op">:</span><span class="fl">16</span><span class="op">]</span>, <span class="va">mean</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, <span class="fu">fmean</span><span class="op">(</span><span class="va">GGDC10S</span><span class="op">[</span><span class="fl">6</span><span class="op">:</span><span class="fl">16</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Unit: microseconds
                 expr     min      lq     mean   median       uq      max neval
                 base 412.369 429.161 773.8810 807.4445 818.8705 7949.178   100
 fmean(GGDC10S[6:16])  94.481  95.856 102.7777 103.9790 108.0860  142.060   100
 cld
  a 
   b</code></pre>
</div>
</div>
<ul>
<li>이처럼, <strong>Collapse</strong>는 data 형식에 구애받지 않고, 보다 빠른 속도를 특징으로 하는 package이다.</li>
</ul>
<p>이들의 문법을 알아보자.</p>
<pre><code>-   Fast Statistical Functions

  Syntax:

FUN(x, g = NULL, \[w = NULL,\] TRA = NULL, \[na.rm = TRUE\], use.g.names = TRUE, \[drop = TRUE,\] \[nthreads = 1,\] ...)

       
Argument            Description
      g             grouping vectors / lists of vectors or ’GRP’ object
      w             a vector of (frequency) weights
    TRA             a quoted operation to transform x using the statistics
  na.rm             efficiently skips missing values in x
  use.g.names       generate names/row-names from g
  drop              drop dimensions if g = TRA = NULL
  nthreads          number of threads for OpenMP multithreading</code></pre>
<p><strong>사용예시</strong> : <strong>fmean</strong></p>
<div class="cell">
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Weighted Mean</span></span>
<span><span class="va">w</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">iris</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/all.equal.html">all.equal</a></span><span class="op">(</span><span class="fu">fmean</span><span class="op">(</span><span class="fu">num_vars</span><span class="op">(</span><span class="va">iris</span><span class="op">)</span>, w <span class="op">=</span> <span class="va">w</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="fu">num_vars</span><span class="op">(</span><span class="va">iris</span><span class="op">)</span>, <span class="va">weighted.mean</span>, w <span class="op">=</span> <span class="va">w</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">wNA</span> <span class="op">&lt;-</span> <span class="fu">na_insert</span><span class="op">(</span><span class="va">w</span>, prop <span class="op">=</span> <span class="fl">0.05</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="fu">num_vars</span><span class="op">(</span><span class="va">iris</span><span class="op">)</span>, <span class="va">weighted.mean</span>, w <span class="op">=</span> <span class="va">wNA</span><span class="op">)</span> <span class="co"># weighted.mean(): 결측치를 처리하지 못한다.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Sepal.Length  Sepal.Width Petal.Length  Petal.Width 
          NA           NA           NA           NA </code></pre>
</div>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">fmean</span><span class="op">(</span><span class="fu">num_vars</span><span class="op">(</span><span class="va">iris</span><span class="op">)</span>, w <span class="op">=</span> <span class="va">wNA</span><span class="op">)</span> <span class="co">#결측치를 자동으로 무시한다.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Sepal.Length  Sepal.Width Petal.Length  Petal.Width 
    5.797389     3.048473     3.683776     1.151507 </code></pre>
</div>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Grouped Mean</span></span>
<span><span class="fu">fmean</span><span class="op">(</span><span class="va">iris</span><span class="op">$</span><span class="va">Sepal.Length</span>, g <span class="op">=</span> <span class="va">iris</span><span class="op">$</span><span class="va">Species</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    setosa versicolor  virginica 
     5.006      5.936      6.588 </code></pre>
</div>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">fmean</span><span class="op">(</span><span class="fu">num_vars</span><span class="op">(</span><span class="va">iris</span><span class="op">)</span>, <span class="va">iris</span><span class="op">$</span><span class="va">Species</span><span class="op">)</span>  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>           Sepal.Length Sepal.Width Petal.Length Petal.Width
setosa            5.006       3.428        1.462       0.246
versicolor        5.936       2.770        4.260       1.326
virginica         6.588       2.974        5.552       2.026</code></pre>
</div>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Weighted Group Mean</span></span>
<span><span class="fu">fmean</span><span class="op">(</span><span class="fu">num_vars</span><span class="op">(</span><span class="va">iris</span><span class="op">)</span>, <span class="va">iris</span><span class="op">$</span><span class="va">Species</span>, <span class="va">w</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>           Sepal.Length Sepal.Width Petal.Length Petal.Width
setosa         5.015518    3.460443     1.479887   0.2495797
versicolor     5.918636    2.698947     4.259102   1.2888099
virginica      6.568402    2.959146     5.577613   2.0433786</code></pre>
</div>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># 속도 상의 이점. </span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span>fmean <span class="op">=</span> <span class="fu">fmean</span><span class="op">(</span><span class="va">iris</span><span class="op">$</span><span class="va">Sepal.Length</span>, <span class="va">iris</span><span class="op">$</span><span class="va">Species</span><span class="op">)</span>,</span>
<span>               tapply <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/tapply.html">tapply</a></span><span class="op">(</span><span class="va">iris</span><span class="op">$</span><span class="va">Sepal.Length</span>, <span class="va">iris</span><span class="op">$</span><span class="va">Species</span>, <span class="va">mean</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Unit: microseconds
   expr    min      lq     mean  median      uq     max neval cld
  fmean  7.488  7.8230  8.49842  8.2905  8.5785  32.276   100  a 
 tapply 46.609 47.8695 49.83706 48.5615 48.9820 152.046   100   b</code></pre>
</div>
</div>
</section><section id="consideration-w-missing-data-결측치-처리" class="level2"><h2 class="anchored" data-anchor-id="consideration-w-missing-data-결측치-처리">Consideration w/ missing data: 결측치 처리</h2>
<div class="cell">
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#wlddev$GINI, g: country, function: mean, median, min, max, sum, prod</span></span>
<span><span class="fu">collap</span><span class="op">(</span><span class="va">wlddev</span>, <span class="va">GINI</span> <span class="op">~</span> <span class="va">country</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">mean</span>, <span class="va">median</span>, <span class="va">min</span>, <span class="va">max</span>, <span class="va">sum</span>, <span class="va">prod</span><span class="op">)</span>,</span>
<span>       na.rm <span class="op">=</span> <span class="cn">TRUE</span>, give.names <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>         country     mean median  min  max   sum         prod
1    Afghanistan      NaN     NA  Inf -Inf   0.0 1.000000e+00
2        Albania 31.41111   31.7 27.0 34.6 282.7 2.902042e+13
3        Algeria 34.36667   35.3 27.6 40.2 103.1 3.916606e+04
4 American Samoa      NaN     NA  Inf -Inf   0.0 1.000000e+00
5        Andorra      NaN     NA  Inf -Inf   0.0 1.000000e+00
6         Angola 48.66667   51.3 42.7 52.0 146.0 1.139065e+05</code></pre>
</div>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># na.rm=T가 기본값이며, NA를 연산한 값은 모두 NA를 결과값으로 반영함. </span></span>
<span><span class="fu">collap</span><span class="op">(</span><span class="va">wlddev</span>, <span class="va">GINI</span> <span class="op">~</span> <span class="va">country</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">fmean</span>, <span class="va">fmedian</span>, <span class="va">fmin</span>, <span class="va">fmax</span>, <span class="va">fsum</span>, <span class="va">fprod</span><span class="op">)</span>,</span>
<span>       give.names <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>         country    fmean fmedian fmin fmax  fsum        fprod
1    Afghanistan       NA      NA   NA   NA    NA           NA
2        Albania 31.41111    31.7 27.0 34.6 282.7 2.902042e+13
3        Algeria 34.36667    35.3 27.6 40.2 103.1 3.916606e+04
4 American Samoa       NA      NA   NA   NA    NA           NA
5        Andorra       NA      NA   NA   NA    NA           NA
6         Angola 48.66667    51.3 42.7 52.0 146.0 1.139065e+05</code></pre>
</div>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span>a <span class="op">=</span> <span class="fu">collap</span><span class="op">(</span><span class="va">wlddev</span>, <span class="va">GINI</span> <span class="op">~</span> <span class="va">country</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">mean</span>, <span class="va">median</span>, <span class="va">min</span>, <span class="va">max</span>, <span class="va">sum</span>, <span class="va">prod</span><span class="op">)</span>,</span>
<span>                          na.rm <span class="op">=</span> <span class="cn">TRUE</span>, give.names <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>               b<span class="op">=</span><span class="fu">collap</span><span class="op">(</span><span class="va">wlddev</span>, <span class="va">GINI</span> <span class="op">~</span> <span class="va">country</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">fmean</span>, <span class="va">fmedian</span>, <span class="va">fmin</span>, <span class="va">fmax</span>, <span class="va">fsum</span>, <span class="va">fprod</span><span class="op">)</span>,</span>
<span>                        give.names <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Unit: microseconds
 expr      min       lq       mean   median         uq       max neval cld
    a 9783.454 9857.552 10483.5492 9942.606 10258.8435 15291.497   100  a 
    b  534.478  577.196   604.1118  615.318   626.4175   855.808   100   b</code></pre>
</div>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># 속도 상 이점을 다시 한 번 확인할 수 있다.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="tra-function" class="level2"><h2 class="anchored" data-anchor-id="tra-function">TRA function</h2>
<ul>
<li>TRA function을 이용, 여러 행/열의 연산을 간편하게 처리할 수 있다.</li>
</ul>
<pre><code>Syntax:
  TRA(x, STATS, FUN = "-", g = NULL, set = FALSE, ...)


  setTRA(x, STATS, FUN = "-", g = NULL, ...)

  STATS = vector/matrix/list of statistics

0        "replace_NA"     replace missing values in x
1        "replace_fill"   replace data and missing values in x
2        "replace"        replace data but preserve missing values in x
3        "-"              subtract (i.e. center)
4        "-+"             center on overall average statistic
5        "/"              divide (i.e. scale)
6        "%"              compute percentages (i.e. divide and multiply by 100)   
7        "+"              add
8        "*"              multiply
9        "%%"             modulus (i.e. remainder from division by STATS)
10       "-%%"            subtract modulus (i.e. make data divisible by STATS)</code></pre>
<div class="cell">
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">dt2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/as.data.table.html">as.data.table</a></span><span class="op">(</span><span class="va">iris</span><span class="op">)</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/attach.html">attach</a></span><span class="op">(</span><span class="va">iris</span><span class="op">)</span>    <span class="co">#data.table에서처럼 변수명을 직접 호출하기 위해 attach를 사용할 수 있다.</span></span>
<span></span>
<span><span class="co"># 평균값과의 차: g= Species</span></span>
<span><span class="fu">all_obj_equal</span><span class="op">(</span><span class="va">Sepal.Length</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/stats/ave.html">ave</a></span><span class="op">(</span><span class="va">Sepal.Length</span>, g <span class="op">=</span> <span class="va">Species</span><span class="op">)</span>,</span>
<span>              <span class="fu">fmean</span><span class="op">(</span><span class="va">Sepal.Length</span>, g <span class="op">=</span> <span class="va">Species</span>, TRA<span class="op">=</span> <span class="st">"-"</span><span class="op">)</span>,</span>
<span>              <span class="fu">TRA</span><span class="op">(</span><span class="va">Sepal.Length</span>, <span class="fu">fmean</span><span class="op">(</span><span class="va">Sepal.Length</span>, g <span class="op">=</span> <span class="va">Species</span><span class="op">)</span>, <span class="st">"-"</span>, g <span class="op">=</span> <span class="va">Species</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span>baseR<span class="op">=</span> <span class="va">Sepal.Length</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/stats/ave.html">ave</a></span><span class="op">(</span><span class="va">Sepal.Length</span>, g <span class="op">=</span> <span class="va">Species</span><span class="op">)</span>,</span>
<span>               fmean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">Sepal.Length</span>, g <span class="op">=</span> <span class="va">Species</span>, TRA<span class="op">=</span> <span class="st">"-"</span><span class="op">)</span>,</span>
<span>               TRA_fmean <span class="op">=</span> <span class="fu">TRA</span><span class="op">(</span><span class="va">Sepal.Length</span>, <span class="fu">fmean</span><span class="op">(</span><span class="va">Sepal.Length</span>, g <span class="op">=</span> <span class="va">Species</span><span class="op">)</span>, <span class="st">"-"</span>, g <span class="op">=</span> <span class="va">Species</span><span class="op">)</span><span class="op">)</span>;<span class="kw"><a href="https://rdrr.io/r/base/detach.html">detach</a></span><span class="op">(</span><span class="va">iris</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Unit: microseconds
      expr    min      lq     mean  median      uq     max neval cld
     baseR 57.640 58.9120 61.35788 59.9555 61.2070 156.905   100 a  
     fmean  3.754  3.9635  4.29474  4.1200  4.2485  19.150   100  b 
 TRA_fmean 11.907 12.4290 13.49149 13.0765 13.4220  55.347   100   c</code></pre>
</div>
</div>
<ul>
<li>
<strong>TRA()</strong>를 사용하기보다 <strong>Fast Statistical Function</strong>에서 <strong>TRA</strong> 기능을 호출하자!</li>
</ul>
<div class="cell">
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#예시</span></span>
<span><span class="fu">num_vars</span><span class="op">(</span><span class="va">dt2</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html">%&lt;&gt;%</a></span>  <span class="fu">na_insert</span><span class="op">(</span>prop <span class="op">=</span> <span class="fl">0.05</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># NA 값을 median값으로 대체.</span></span>
<span><span class="fu">num_vars</span><span class="op">(</span><span class="va">dt2</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">fmedian</span><span class="op">(</span><span class="va">iris</span><span class="op">$</span><span class="va">Species</span>, TRA <span class="op">=</span> <span class="st">"replace_NA"</span>, set <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co"># num_vars(dt2) |&gt; fmean(iris$Species, TRA = "replace_NA", set = TRUE) --&gt; mean으로 대체.</span></span>
<span></span>
<span></span>
<span><span class="co"># 다양한 연산 및 작업을 한 번에 다룰 수 있다.</span></span>
<span><span class="va">mtcars</span> <span class="op">|&gt;</span> <span class="fu">ftransform</span><span class="op">(</span>A <span class="op">=</span> <span class="fu">fsum</span><span class="op">(</span><span class="va">mpg</span>, TRA <span class="op">=</span> <span class="st">"%"</span><span class="op">)</span>,</span>
<span>                     B <span class="op">=</span> <span class="va">mpg</span> <span class="op">&gt;</span> <span class="fu">fmedian</span><span class="op">(</span><span class="va">mpg</span>, <span class="va">cyl</span>, TRA <span class="op">=</span> <span class="st">"replace_fill"</span><span class="op">)</span>,</span>
<span>                     C <span class="op">=</span> <span class="fu">fmedian</span><span class="op">(</span><span class="va">mpg</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">vs</span>, <span class="va">am</span><span class="op">)</span>, <span class="va">wt</span>, <span class="st">"-"</span><span class="op">)</span>,</span>
<span>                     D <span class="op">=</span> <span class="fu">fmean</span><span class="op">(</span><span class="va">mpg</span>, <span class="va">vs</span>,, <span class="fl">1L</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fu">fmean</span><span class="op">(</span><span class="va">mpg</span>, <span class="va">am</span>,, <span class="fl">1L</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>               mpg cyl disp  hp drat    wt  qsec vs am gear carb        A     B
Mazda RX4     21.0   6  160 110 3.90 2.620 16.46  0  1    4    4 3.266449  TRUE
Mazda RX4 Wag 21.0   6  160 110 3.90 2.875 17.02  0  1    4    4 3.266449  TRUE
Datsun 710    22.8   4  108  93 3.85 2.320 18.61  1  1    4    1 3.546430 FALSE
                 C     D
Mazda RX4      1.3 FALSE
Mazda RX4 Wag  1.3 FALSE
Datsun 710    -7.6  TRUE</code></pre>
</div>
</div>
</section><section id="grouping-object" class="level2"><h2 class="anchored" data-anchor-id="grouping-object">Grouping Object</h2>
<ul>
<li>
<p>GRP function을 이용, group을 쉽게 연산할 수 있다.</p>
<pre><code>Syntax:

    GRP(X, by = NULL, sort == TRUE, decreasing = FALSE, na.last = TRUE, 
    return.groups = TRUE, return.order = sort, method = "auto", ...)</code></pre>
</li>
</ul>
<div class="cell">
<div class="sourceCode" id="cb55"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">g</span> <span class="op">&lt;-</span> <span class="fu">GRP</span><span class="op">(</span><span class="va">iris</span>, by <span class="op">=</span> <span class="op">~</span> <span class="va">Species</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">g</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>collapse grouping object of length 150 with 3 ordered groups

Call: GRP.default(X = iris, by = ~Species), X is sorted

Distribution of group sizes: 
   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
     50      50      50      50      50      50 

Groups with sizes: 
    setosa versicolor  virginica 
        50         50         50 </code></pre>
</div>
<div class="sourceCode" id="cb57"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="va">g</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Class 'GRP'  hidden list of 9
 $ N.groups    : int 3
 $ group.id    : int [1:150] 1 1 1 1 1 1 1 1 1 1 ...
 $ group.sizes : int [1:3] 50 50 50
 $ groups      :'data.frame':   3 obs. of  1 variable:
  ..$ Species: Factor w/ 3 levels "setosa","versicolor",..: 1 2 3
 $ group.vars  : chr "Species"
 $ ordered     : Named logi [1:2] TRUE TRUE
  ..- attr(*, "names")= chr [1:2] "ordered" "sorted"
 $ order       : int [1:150] 1 2 3 4 5 6 7 8 9 10 ...
  ..- attr(*, "starts")= int [1:3] 1 51 101
  ..- attr(*, "maxgrpn")= int 50
  ..- attr(*, "sorted")= logi TRUE
 $ group.starts: int [1:3] 1 51 101
 $ call        : language GRP.default(X = iris, by = ~Species)</code></pre>
</div>
<div class="sourceCode" id="cb59"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># GRP 기능- 호출하여 사용하자!</span></span>
<span><span class="fu">fmean</span><span class="op">(</span><span class="fu">num_vars</span><span class="op">(</span><span class="va">iris</span><span class="op">)</span>, <span class="va">g</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>           Sepal.Length Sepal.Width Petal.Length Petal.Width
setosa            5.006       3.428        1.462       0.246
versicolor        5.936       2.770        4.260       1.326
virginica         6.588       2.974        5.552       2.026</code></pre>
</div>
<div class="sourceCode" id="cb61"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">fmean</span><span class="op">(</span><span class="fu">num_vars</span><span class="op">(</span><span class="va">iris</span><span class="op">)</span>, <span class="va">iris</span><span class="op">$</span><span class="va">Species</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>           Sepal.Length Sepal.Width Petal.Length Petal.Width
setosa            5.006       3.428        1.462       0.246
versicolor        5.936       2.770        4.260       1.326
virginica         6.588       2.974        5.552       2.026</code></pre>
</div>
</div>
</section><section id="factors-in-operation" class="level2"><h2 class="anchored" data-anchor-id="factors-in-operation">Factors in operation</h2>
<p><strong>Collaspe</strong>는 형식에 구애받지 않는다; factor를 바로 연산할 수 있으며, <strong>qF</strong>로 빠르게 factor를 생성할 수 있다.</p>
<div class="cell">
<div class="sourceCode" id="cb63"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu">na_insert</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">1e7</span><span class="op">)</span>, prop <span class="op">=</span> <span class="fl">0.01</span><span class="op">)</span> </span>
<span><span class="va">g</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample.int</a></span><span class="op">(</span><span class="fl">1e6</span>, <span class="fl">1e7</span>, <span class="cn">TRUE</span><span class="op">)</span>         </span>
<span><span class="co"># grp와 비교</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span><span class="op">(</span><span class="va">gg</span> <span class="op">&lt;-</span> <span class="fu">GRP</span><span class="op">(</span><span class="va">g</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   user  system elapsed 
  0.649   0.027   0.677 </code></pre>
</div>
<div class="sourceCode" id="cb65"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span><span class="op">(</span><span class="va">f</span> <span class="op">&lt;-</span> <span class="fu">qF</span><span class="op">(</span><span class="va">g</span>, na.exclude <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   user  system elapsed 
  0.254   0.044   0.298 </code></pre>
</div>
<div class="sourceCode" id="cb67"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">f</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "factor"      "na.included"</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode" id="cb69"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span><span class="fu">fmean</span><span class="op">(</span><span class="va">x</span>, <span class="va">g</span><span class="op">)</span>, </span>
<span>               <span class="fu">fmean</span><span class="op">(</span><span class="va">x</span>, <span class="va">gg</span><span class="op">)</span>, </span>
<span>               <span class="fu">fmean</span><span class="op">(</span><span class="va">x</span>, <span class="va">gg</span>, na.rm <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>, </span>
<span>               <span class="fu">fmean</span><span class="op">(</span><span class="va">x</span>, <span class="va">f</span><span class="op">)</span><span class="op">)</span></span>
<span> <span class="co">## Unit: milliseconds</span></span>
<span> <span class="co">##       expr                    min         lq          mean        median</span></span>
<span> <span class="co">## fmean(x, g)                   146.060983  150.493309  155.02585   152.197822</span></span>
<span> <span class="co">## fmean(x, gg)                  25.354564   27.709625   29.48497    29.022157</span></span>
<span> <span class="co">## fmean(x, gg, na.rm = FALSE)   13.184534   13.783585   15.61769    14.128067</span></span>
<span> <span class="co">## fmean(x, f)                   24.847271   27.503661   29.47271    29.248580</span></span>
<span></span>
<span><span class="co"># qF를 통해 grp와 유사한 성능 향상을 기대할 수 있다.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="summary-fast-grouping-and-ordering" class="level2"><h2 class="anchored" data-anchor-id="summary-fast-grouping-and-ordering">Summary: FAST grouping and Ordering</h2>
<pre><code>다양한 기능이 있다. 
GRP()           Fast sorted or unsorted grouping of multivariate data, returns detailed object of class ’GRP’ 
qF()/qG()       Fast generation of factors and quick-group (’qG’) objects from atomic vectors 
finteraction()  Fast interactions: returns factor or ’qG’ objects 
fdroplevels()   Efficiently remove unused factor levels

radixorder()    Fast ordering and ordered grouping 
group()         Fast first-appearance-order grouping: returns ’qG’ object 
gsplit()        Split vector based on ’GRP’ object 
greorder()      Reorder the results

- that also return ’qG’ objects 
groupid()       Generalized run-length-type grouping seqid() Grouping of integer sequences 
timeid()        Grouping of time sequences (based on GCD)

dapply()        Apply a function to rows or columns of data.frame or matrix based objects. 
BY()            Apply a function to vectors or matrix/data frame columns by groups.

-   Specialized Data Transformation Functions 
fbetween()      Fast averaging and (quasi-)centering. 
fwithin()
fhdbetween()    Higher-Dimensional averaging/centering and linear prediction/partialling out 
fhdwithin()     (powered by fixest’s algorithm for multiple factors).
fscale()        (advanced) scaling and centering.

-   Time / Panel Series Functions 
fcumsum()       Cumulative sums 
flag()          Lags and leads 
fdiff()         (Quasi-, Log-, Iterated-) differences 
fgrowth()       (Compounded-) growth rates

-    Data manipulation functions
fselect(),      fsubset(),      fgroup_by(),    [f/set]transform[v](),          
fmutate(),      fsummarise(),   across(),       roworder[v](),            
colorder[v](),  [f/set]rename(),                [set]relabel()</code></pre>
</section><section id="collapse는-빠르다" class="level2"><h2 class="anchored" data-anchor-id="collapse는-빠르다">Collapse는 빠르다!</h2>
<div class="cell">
<div class="sourceCode" id="cb71"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">fdim</span><span class="op">(</span><span class="va">wlddev</span><span class="op">)</span>    <span class="co">##faster dim for dt. col/row: 13176 13</span></span>
<span></span>
<span><span class="co"># 1990년 이후를 기준으로, ODA/POP의 값 (g: region, income, OECD)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span> </span>
<span>  </span>
<span>dplyr <span class="op">=</span> <span class="fu">qDT</span><span class="op">(</span><span class="va">wlddev</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">year</span> <span class="op">&gt;=</span> <span class="fl">1990</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>ODA_POP <span class="op">=</span> <span class="va">ODA</span> <span class="op">/</span> <span class="va">POP</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">region</span>, <span class="va">income</span>, <span class="va">OECD</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="va">PCGDP</span><span class="op">:</span><span class="va">POP</span>, <span class="va">sum</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, .groups <span class="op">=</span> <span class="st">"drop"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">income</span>, <span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op">(</span><span class="va">PCGDP</span><span class="op">)</span><span class="op">)</span>,</span>
<span></span>
<span>data.table <span class="op">=</span> <span class="fu">qDT</span><span class="op">(</span><span class="va">wlddev</span><span class="op">)</span><span class="op">[</span>, <span class="va">ODA_POP</span> <span class="op">:=</span> <span class="va">ODA</span> <span class="op">/</span> <span class="va">POP</span><span class="op">]</span><span class="op">[</span></span>
<span>             <span class="va">year</span> <span class="op">&gt;=</span> <span class="fl">1990</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">.SD</span>, <span class="va">sum</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>             by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">region</span>, <span class="va">income</span>, <span class="va">OECD</span><span class="op">)</span>, .SDcols <span class="op">=</span> <span class="va">PCGDP</span><span class="op">:</span><span class="va">ODA_POP</span><span class="op">]</span><span class="op">[</span></span>
<span>             <span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="va">income</span>, <span class="op">-</span><span class="va">PCGDP</span><span class="op">)</span><span class="op">]</span>,</span>
<span></span>
<span>collapse_base <span class="op">=</span> <span class="fu">qDT</span><span class="op">(</span><span class="va">wlddev</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>                <span class="fu">fsubset</span><span class="op">(</span><span class="va">year</span> <span class="op">&gt;=</span> <span class="fl">1990</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>                <span class="fu">fmutate</span><span class="op">(</span>ODA_POP <span class="op">=</span> <span class="va">ODA</span> <span class="op">/</span> <span class="va">POP</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>                <span class="fu">fgroup_by</span><span class="op">(</span><span class="va">region</span>, <span class="va">income</span>, <span class="va">OECD</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>                <span class="fu">fsummarise</span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="va">PCGDP</span><span class="op">:</span><span class="va">ODA_POP</span>, <span class="va">sum</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>                <span class="fu">roworder</span><span class="op">(</span><span class="va">income</span>, <span class="op">-</span><span class="va">PCGDP</span><span class="op">)</span>,</span>
<span></span>
<span>collapse_optimized <span class="op">=</span> <span class="fu">qDT</span><span class="op">(</span><span class="va">wlddev</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>                    <span class="fu">fsubset</span><span class="op">(</span><span class="va">year</span> <span class="op">&gt;=</span> <span class="fl">1990</span>, <span class="va">region</span>, <span class="va">income</span>, <span class="va">OECD</span>, <span class="va">PCGDP</span><span class="op">:</span><span class="va">POP</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>                    <span class="fu">fmutate</span><span class="op">(</span>ODA_POP <span class="op">=</span> <span class="va">ODA</span> <span class="op">/</span> <span class="va">POP</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>                    <span class="fu">fgroup_by</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, sort <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">fsum</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>                    <span class="fu">roworder</span><span class="op">(</span><span class="va">income</span>, <span class="op">-</span><span class="va">PCGDP</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co">## Unit: microseconds</span></span>
<span><span class="co">##        expr            min         lq            mean            median          uq            max         neval</span></span>
<span><span class="co">## dplyr                  71955.523   72291.9715    80009.2208      72453.1165      76902.671   393947.262  100 </span></span>
<span><span class="co">## data.table             5960.503    6310.7045     7116.6673       6721.3450       7046.837    18615.736     100   </span></span>
<span><span class="co">## collapse_base          859.505     948.2200      1041.1137       990.1375        1061.864     3148.804       100 </span></span>
<span><span class="co">## collapse_optimized     442.040     482.9705      542.6927        523.6950        574.921     1036.817      100   </span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="collapse-w-fast-statistical-function-다양한-활용" class="level2"><h2 class="anchored" data-anchor-id="collapse-w-fast-statistical-function-다양한-활용">Collapse w/ Fast Statistical Function: 다양한 활용</h2>
<div class="cell">
<div class="sourceCode" id="cb72"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># 아래 셋은 동일한 결과를 보인다.</span></span>
<span><span class="co"># cyl별 mpg sum</span></span>
<span> <span class="va">mtcars</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu">ftransform</span><span class="op">(</span>mpg_sum <span class="op">=</span> <span class="fu">fsum</span><span class="op">(</span><span class="va">mpg</span>, g <span class="op">=</span> <span class="va">cyl</span>, TRA <span class="op">=</span> <span class="st">"replace_fill"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/invisible.html">invisible</a></span><span class="op">(</span><span class="op">)</span></span>
<span> <span class="va">mtcars</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu">fgroup_by</span><span class="op">(</span><span class="va">cyl</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu">ftransform</span><span class="op">(</span>mpg_sum <span class="op">=</span> <span class="fu">fsum</span><span class="op">(</span><span class="va">mpg</span>, <span class="fu">GRP</span><span class="op">(</span><span class="va">.</span><span class="op">)</span>, TRA <span class="op">=</span> <span class="st">"replace_fill"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/invisible.html">invisible</a></span><span class="op">(</span><span class="op">)</span></span>
<span> <span class="va">mtcars</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu">fgroup_by</span><span class="op">(</span><span class="va">cyl</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu">fmutate</span><span class="op">(</span>mpg_sum <span class="op">=</span> <span class="fu">fsum</span><span class="op">(</span><span class="va">mpg</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                   mpg cyl  disp  hp drat    wt  qsec vs am gear carb mpg_sum
Mazda RX4         21.0   6 160.0 110 3.90 2.620 16.46  0  1    4    4   138.2
Mazda RX4 Wag     21.0   6 160.0 110 3.90 2.875 17.02  0  1    4    4   138.2
Datsun 710        22.8   4 108.0  93 3.85 2.320 18.61  1  1    4    1   293.3
Hornet 4 Drive    21.4   6 258.0 110 3.08 3.215 19.44  1  0    3    1   138.2
Hornet Sportabout 18.7   8 360.0 175 3.15 3.440 17.02  0  0    3    2   211.4
Valiant           18.1   6 225.0 105 2.76 3.460 20.22  1  0    3    1   138.2
Duster 360        14.3   8 360.0 245 3.21 3.570 15.84  0  0    3    4   211.4
Merc 240D         24.4   4 146.7  62 3.69 3.190 20.00  1  0    4    2   293.3
Merc 230          22.8   4 140.8  95 3.92 3.150 22.90  1  0    4    2   293.3
Merc 280          19.2   6 167.6 123 3.92 3.440 18.30  1  0    4    4   138.2</code></pre>
</div>
</div>
<ul>
<li>ad-hoc grouping, often <strong>fastest!</strong>
</li>
</ul>
<div class="cell">
<div class="sourceCode" id="cb74"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span>a<span class="op">=</span><span class="va">mtcars</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu">ftransform</span><span class="op">(</span>mpg_sum <span class="op">=</span> <span class="fu">fsum</span><span class="op">(</span><span class="va">mpg</span>, g <span class="op">=</span> <span class="va">cyl</span>, TRA <span class="op">=</span> <span class="st">"replace_fill"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>               b<span class="op">=</span><span class="va">mtcars</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu">fgroup_by</span><span class="op">(</span><span class="va">cyl</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu">ftransform</span><span class="op">(</span>mpg_sum <span class="op">=</span> <span class="fu">fsum</span><span class="op">(</span><span class="va">mpg</span>, <span class="fu">GRP</span><span class="op">(</span><span class="va">.</span><span class="op">)</span>, TRA <span class="op">=</span> <span class="st">"replace_fill"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>               c<span class="op">=</span><span class="va">mtcars</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu">fgroup_by</span><span class="op">(</span><span class="va">cyl</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu">fmutate</span><span class="op">(</span>mpg_sum <span class="op">=</span> <span class="fu">fsum</span><span class="op">(</span><span class="va">mpg</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Unit: microseconds
 expr    min      lq     mean  median      uq     max neval cld
    a 27.362 28.9525 30.22495 29.9020 31.5925  39.924   100 a  
    b 64.001 66.0010 68.26108 67.2155 68.9120 114.379   100  b 
    c 78.678 80.4105 84.21481 81.2445 82.4050 264.876   100   c</code></pre>
</div>
</div>
<ul>
<li>
<strong>ftransform()</strong>은 앞의 <strong>fgroupby</strong>를 무시한다. 아래 둘은 값이 다르다. (<strong>fmutate, fsummarise</strong>만 이전 group을 반영한다.)</li>
</ul>
<div class="cell">
<div class="sourceCode" id="cb76"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">mtcars</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu">fgroup_by</span><span class="op">(</span><span class="va">cyl</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu">ftransform</span><span class="op">(</span>mpg_sum <span class="op">=</span> <span class="fu">fsum</span><span class="op">(</span><span class="va">mpg</span>, <span class="fu">GRP</span><span class="op">(</span><span class="va">.</span><span class="op">)</span>, TRA <span class="op">=</span> <span class="st">"replace_fill"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                   mpg cyl disp  hp drat    wt  qsec vs am gear carb mpg_sum
Mazda RX4         21.0   6  160 110 3.90 2.620 16.46  0  1    4    4   138.2
Mazda RX4 Wag     21.0   6  160 110 3.90 2.875 17.02  0  1    4    4   138.2
Datsun 710        22.8   4  108  93 3.85 2.320 18.61  1  1    4    1   293.3
Hornet 4 Drive    21.4   6  258 110 3.08 3.215 19.44  1  0    3    1   138.2
Hornet Sportabout 18.7   8  360 175 3.15 3.440 17.02  0  0    3    2   211.4
Valiant           18.1   6  225 105 2.76 3.460 20.22  1  0    3    1   138.2</code></pre>
</div>
<div class="sourceCode" id="cb78"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">mtcars</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu">fgroup_by</span><span class="op">(</span><span class="va">cyl</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu">ftransform</span><span class="op">(</span>mpg_sum <span class="op">=</span> <span class="fu">fsum</span><span class="op">(</span><span class="va">mpg</span>, TRA <span class="op">=</span> <span class="st">"replace_fill"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                   mpg cyl disp  hp drat    wt  qsec vs am gear carb mpg_sum
Mazda RX4         21.0   6  160 110 3.90 2.620 16.46  0  1    4    4   642.9
Mazda RX4 Wag     21.0   6  160 110 3.90 2.875 17.02  0  1    4    4   642.9
Datsun 710        22.8   4  108  93 3.85 2.320 18.61  1  1    4    1   642.9
Hornet 4 Drive    21.4   6  258 110 3.08 3.215 19.44  1  0    3    1   642.9
Hornet Sportabout 18.7   8  360 175 3.15 3.440 17.02  0  0    3    2   642.9
Valiant           18.1   6  225 105 2.76 3.460 20.22  1  0    3    1   642.9</code></pre>
</div>
</div>
<ul>
<li>위 언급과 같이 <strong>baseR</strong> 의 <strong>“/”</strong>보다 <strong>collapse</strong>의 <strong>TRA function</strong>을 이용하는 것이 더 빠르다.</li>
</ul>
<div class="cell">
<div class="sourceCode" id="cb80"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span></span>
<span><span class="st">"/"</span><span class="op">=</span>      <span class="va">mtcars</span> <span class="op">|&gt;</span> <span class="fu">fgroup_by</span><span class="op">(</span><span class="va">cyl</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">fmutate</span><span class="op">(</span>mpg_prop <span class="op">=</span> <span class="va">mpg</span> <span class="op">/</span> <span class="fu">fsum</span><span class="op">(</span><span class="va">mpg</span><span class="op">)</span><span class="op">)</span>      <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="op">)</span>,     </span>
<span><span class="st">"TRA=/"</span> <span class="op">=</span> <span class="va">mtcars</span> <span class="op">|&gt;</span> <span class="fu">fgroup_by</span><span class="op">(</span><span class="va">cyl</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">fmutate</span><span class="op">(</span>mpg_prop <span class="op">=</span> <span class="fu">fsum</span><span class="op">(</span><span class="va">mpg</span>, TRA <span class="op">=</span> <span class="st">"/"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Unit: microseconds
  expr     min       lq     mean   median       uq     max neval cld
     / 207.643 210.3915 214.5014 212.7320 215.4790 281.881   100  a 
 TRA=/ 196.455 200.0970 205.9386 202.4655 205.0695 471.228   100   b</code></pre>
</div>
</div>
<ul>
<li>
<strong>fsum</strong>은 grp 별로 연산을 처리하나, sum은 전체를 반영한다.</li>
</ul>
<div class="cell">
<div class="sourceCode" id="cb82"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">mtcars</span> <span class="op">|&gt;</span> <span class="fu">fgroup_by</span><span class="op">(</span><span class="va">cyl</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">fmutate</span><span class="op">(</span>mpg_prop2 <span class="op">=</span> <span class="fu">fsum</span><span class="op">(</span><span class="va">mpg</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">mpg</span><span class="op">)</span><span class="op">)</span><span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="op">)</span> <span class="co">#"!=1" </span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                   mpg cyl disp  hp drat    wt  qsec vs am gear carb mpg_prop2
Mazda RX4         21.0   6  160 110 3.90 2.620 16.46  0  1    4    4 0.2149634
Mazda RX4 Wag     21.0   6  160 110 3.90 2.875 17.02  0  1    4    4 0.2149634
Datsun 710        22.8   4  108  93 3.85 2.320 18.61  1  1    4    1 0.4562140
Hornet 4 Drive    21.4   6  258 110 3.08 3.215 19.44  1  0    3    1 0.2149634
Hornet Sportabout 18.7   8  360 175 3.15 3.440 17.02  0  0    3    2 0.3288225
Valiant           18.1   6  225 105 2.76 3.460 20.22  1  0    3    1 0.2149634</code></pre>
</div>
</div>
<ul>
<li>자유로운 <strong>%&gt;%</strong> 의 사용</li>
</ul>
<div class="cell">
<div class="sourceCode" id="cb84"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># 아래 둘은 동일하다.</span></span>
<span> <span class="va">mtcars</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu">fgroup_by</span><span class="op">(</span><span class="va">cyl</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu">ftransform</span><span class="op">(</span><span class="fu">fselect</span><span class="op">(</span><span class="va">.</span>, <span class="va">hp</span><span class="op">:</span><span class="va">qsec</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu">fsum</span><span class="op">(</span>TRA <span class="op">=</span> <span class="st">"/"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/invisible.html">invisible</a></span><span class="op">(</span><span class="op">)</span></span>
<span> <span class="va">mtcars</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu">fgroup_by</span><span class="op">(</span><span class="va">cyl</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu">fmutate</span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="va">hp</span><span class="op">:</span><span class="va">qsec</span>, <span class="va">fsum</span>, TRA <span class="op">=</span> <span class="st">"/"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                   mpg cyl disp         hp       drat         wt       qsec vs
Mazda RX4         21.0   6  160 0.12850467 0.15537849 0.12007333 0.13080102  0
Mazda RX4 Wag     21.0   6  160 0.12850467 0.15537849 0.13175985 0.13525111  0
Datsun 710        22.8   4  108 0.10231023 0.08597588 0.09227220 0.08840435  1
Hornet 4 Drive    21.4   6  258 0.12850467 0.12270916 0.14734189 0.15448188  1
Hornet Sportabout 18.7   8  360 0.05974735 0.06967485 0.06144064 0.07248414  0
Valiant           18.1   6  225 0.12266355 0.10996016 0.15857012 0.16068023  1
                  am gear carb
Mazda RX4          1    4    4
Mazda RX4 Wag      1    4    4
Datsun 710         1    4    1
Hornet 4 Drive     0    3    1
Hornet Sportabout  0    3    2
Valiant            0    3    1</code></pre>
</div>
</div>
<ul>
<li>
<strong>set = TRUE</strong>를 통해 원본 데이터에 반영할 수 있다.</li>
</ul>
<div class="cell">
<div class="sourceCode" id="cb86"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">mtcars</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                   mpg cyl disp  hp drat    wt  qsec vs am gear carb
Mazda RX4         21.0   6  160 110 3.90 2.620 16.46  0  1    4    4
Mazda RX4 Wag     21.0   6  160 110 3.90 2.875 17.02  0  1    4    4
Datsun 710        22.8   4  108  93 3.85 2.320 18.61  1  1    4    1
Hornet 4 Drive    21.4   6  258 110 3.08 3.215 19.44  1  0    3    1
Hornet Sportabout 18.7   8  360 175 3.15 3.440 17.02  0  0    3    2
Valiant           18.1   6  225 105 2.76 3.460 20.22  1  0    3    1</code></pre>
</div>
<div class="sourceCode" id="cb88"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># mtcars의 열 hp:qsec의 값과 해당하는 g:cyl별 합의 비율.</span></span>
<span><span class="va">mtcars</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu">fgroup_by</span><span class="op">(</span><span class="va">cyl</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu">fmutate</span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="va">hp</span><span class="op">:</span><span class="va">qsec</span>, <span class="va">fsum</span>, TRA <span class="op">=</span> <span class="st">"/"</span>, set <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/invisible.html">invisible</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">mtcars</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                   mpg cyl disp         hp       drat         wt       qsec vs
Mazda RX4         21.0   6  160 0.12850467 0.15537849 0.12007333 0.13080102  0
Mazda RX4 Wag     21.0   6  160 0.12850467 0.15537849 0.13175985 0.13525111  0
Datsun 710        22.8   4  108 0.10231023 0.08597588 0.09227220 0.08840435  1
Hornet 4 Drive    21.4   6  258 0.12850467 0.12270916 0.14734189 0.15448188  1
Hornet Sportabout 18.7   8  360 0.05974735 0.06967485 0.06144064 0.07248414  0
Valiant           18.1   6  225 0.12266355 0.10996016 0.15857012 0.16068023  1
                  am gear carb
Mazda RX4          1    4    4
Mazda RX4 Wag      1    4    4
Datsun 710         1    4    1
Hornet 4 Drive     0    3    1
Hornet Sportabout  0    3    2
Valiant            0    3    1</code></pre>
</div>
</div>
<ul>
<li>
<strong>.apply = FALSE</strong>를 통해 subset group에만 적용할 수 있다.</li>
</ul>
<div class="cell">
<div class="sourceCode" id="cb90"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># 각 g:cyl의 hp:qsec까지의 변수에 대한 부분 상관관계</span></span>
<span><span class="va">mtcars</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu">fgroup_by</span><span class="op">(</span><span class="va">cyl</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu">fsummarise</span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="va">hp</span><span class="op">:</span><span class="va">qsec</span>, \<span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu">qDF</span><span class="op">(</span><span class="fu">pwcor</span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, <span class="st">"var"</span><span class="op">)</span>, .apply <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  cyl  var         hp       drat         wt       qsec
1   4   hp  1.0000000 -0.4702200  0.1598761 -0.1783611
2   4 drat -0.4702200  1.0000000 -0.4788681 -0.2833656
3   4   wt  0.1598761 -0.4788681  1.0000000  0.6380214
4   4 qsec -0.1783611 -0.2833656  0.6380214  1.0000000
5   6   hp  1.0000000  0.2171636 -0.3062284 -0.6280148
6   6 drat  0.2171636  1.0000000 -0.3546583 -0.6231083</code></pre>
</div>
</div>
</section><section id="이름순번vectors정규표현식으로-행열을-지칭할-수-있다." class="level2"><h2 class="anchored" data-anchor-id="이름순번vectors정규표현식으로-행열을-지칭할-수-있다.">이름/순번/vectors/정규표현식으로 행/열을 지칭할 수 있다.</h2>
<pre><code>get_vars(x, vars, return = "names", regex = FALSE, ...) 
get_vars(x, vars, regex = FALSE, ...) &lt;- value 

- 위치도 선택가능하다.
add_vars(x, ..., pos = "end") 
add_vars(x, pos = "end") &lt;- value 

- data type을 지정할 수 있다. 
num_vars(x, return = "data");   cat_vars(x, return = "data");   char_vars(x, return = "data"); 
fact_vars(x, return = "data");  logi_vars(x, return = "data");  date_vars(x, return = "data") 

- replace 또한 가능하다.
num_vars(x) &lt;- value;   cat_vars(x) &lt;- value;   char_vars(x) &lt;- value; 
fact_vars(x) &lt;- value;  logi_vars(x) &lt;- value;  date_vars(x) &lt;- value</code></pre>
</section><section id="efficient-programming" class="level2"><h2 class="anchored" data-anchor-id="efficient-programming">Efficient programming</h2>
<pre><code>    &gt; quick data conversion
-   qDF(),  qDT(),  qTBL(),   qM(),   mrtl(),   mctl()
    
-   anyv(x, value) / allv(x, value)     # Faster than any/all(x == value)
-   allNA(x)                            # Faster than all(is.na(x))
-   whichv(x, value, invert = F)        # Faster than which(x (!/=)= value)
-   whichNA(x, invert = FALSE)          # Faster than which((!)is.na(x))
-   x %(!/=)=% value                    # Infix for whichv(v, value, TRUE/FALSE)
-   setv(X, v, R, ...)                  # x\[x(!/=)=v\]\&lt;-r / x\[v\]\&lt;-r\[v\] (by reference)
-   setop(X, op, V, rowwise = F)        # Faster than X \&lt;- X +/-/\*// V (by reference)
-   X %(+,-,\*,/)=% V                   # Infix for setop,()
-   na_rm(x)                            # Fast: if(anyNA(x)) x\[!is.na(x)\] else x,
-   na_omit(X, cols = NULL, ...)        # Faster na.omit for matrices and data frames
-   vlengths(X, use.names=TRUE)         # Faster version of lengths()
-   frange(x, na.rm = TRUE)             # Much faster base::range
-   fdim(X)                             # Faster dim for data frames</code></pre>
</section></section><section id="collapse-and-data.table" class="level1"><h1>Collapse and data.table</h1>
<p><strong>data.table</strong>에서 <strong>collapse</strong>의 적용을 알아보자.</p>
<div class="cell">
<div class="sourceCode" id="cb94"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">DT</span> <span class="op">&lt;-</span> <span class="fu">qDT</span><span class="op">(</span><span class="va">wlddev</span><span class="op">)</span> <span class="co"># as.data.table(wlddev)</span></span>
<span><span class="va">DT</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu">fgroup_by</span><span class="op">(</span><span class="va">country</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu">get_vars</span><span class="op">(</span><span class="fl">9</span><span class="op">:</span><span class="fl">13</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu">fmean</span><span class="op">(</span><span class="op">)</span>  <span class="co">#fgroup_by == gby</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                   country      PCGDP   LIFEEX     GINI        ODA         POP
                    &lt;char&gt;      &lt;num&gt;    &lt;num&gt;    &lt;num&gt;      &lt;num&gt;       &lt;num&gt;
  1:           Afghanistan   483.8351 49.19717       NA 1487548499 18362258.22
  2:               Albania  2819.2400 71.68027 31.41111  312928126  2708297.17
  3:               Algeria  3532.2714 63.56290 34.36667  612238500 25305290.68
  4:        American Samoa 10071.0659       NA       NA         NA    43115.10
  5:               Andorra 40083.0911       NA       NA         NA    51547.35
 ---                                                                          
212: Virgin Islands (U.S.) 35629.7336 73.71292       NA         NA    92238.53
213:    West Bank and Gaza  2388.4348 71.60780 34.52500 1638581462  3312289.13
214:           Yemen, Rep.  1069.6596 52.53707 35.46667  859950996 13741375.82
215:                Zambia  1318.8627 51.09263 52.68889  734624330  8614972.38
216:              Zimbabwe  1219.4360 54.53360 45.93333  397104997  9402160.33</code></pre>
</div>
<div class="sourceCode" id="cb96"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">DT</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">.SD</span>, <span class="va">mean</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, keyby <span class="op">=</span> <span class="va">country</span>, .SDcols <span class="op">=</span> <span class="fl">9</span><span class="op">:</span><span class="fl">13</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>  <span class="fu"><a href="https://rdrr.io/r/base/invisible.html">invisible</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">collap</span><span class="op">(</span><span class="va">DT</span>, <span class="op">~</span> <span class="va">country</span>, <span class="va">fmean</span>, cols <span class="op">=</span> <span class="fl">9</span><span class="op">:</span><span class="fl">13</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/invisible.html">invisible</a></span><span class="op">(</span><span class="op">)</span>     <span class="co">#same</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span>collapse     <span class="op">=</span> <span class="va">DT</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu">gby</span><span class="op">(</span><span class="va">country</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu">get_vars</span><span class="op">(</span><span class="fl">9</span><span class="op">:</span><span class="fl">13</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">fmean</span>,</span>
<span>               data.table   <span class="op">=</span> <span class="va">DT</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">.SD</span>, <span class="va">mean</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, keyby <span class="op">=</span> <span class="va">country</span>, .SDcols <span class="op">=</span> <span class="fl">9</span><span class="op">:</span><span class="fl">13</span><span class="op">]</span>,</span>
<span>               data.table2  <span class="op">=</span> <span class="va">DT</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">.SD</span>, <span class="va">fmean</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, keyby <span class="op">=</span> <span class="va">country</span>, .SDcols <span class="op">=</span> <span class="fl">9</span><span class="op">:</span><span class="fl">13</span><span class="op">]</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Unit: microseconds
        expr      min        lq      mean   median        uq      max neval cld
    collapse  334.570  368.7865  389.3642  396.088  400.6755  668.870   100 a  
  data.table 5047.715 5215.1535 5386.4627 5293.606 5492.7620 8787.870   100  b 
 data.table2 5215.911 5295.7220 5637.0815 5379.914 5587.5015 9707.914   100   c</code></pre>
</div>
</div>
<ul>
<li><p><em>DT[, lapply(.SD, fmean,…)]</em>가 <em>DT[, lapply(.SD, mean,…)]</em>보다 느린 것을 확인할 수 있다. <strong>data.table</strong> 내에서 <strong>mean</strong>은 <strong>baseR</strong>의 <strong>mean</strong>이 아닌 <strong>gmean</strong>으로 <strong>data.table</strong>에 최적화되어있다. 반면, <strong>lapply</strong>와 함께 <strong>fmean</strong>을 사용하면 최적화된 방식으로 동작하지 않아 오히려 더 느리다.</p></li>
<li><p>위 방식은 아래와 처리되는 방식이 유사하다. <strong>fmean</strong>을 모든 <strong>group, columns</strong>에 적용하기에 느리다.</p></li>
</ul>
<div class="cell">
<div class="sourceCode" id="cb98"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">BY</span><span class="op">(</span><span class="fu">gv</span><span class="op">(</span><span class="va">DT</span>, <span class="fl">9</span><span class="op">:</span><span class="fl">13</span><span class="op">)</span>, <span class="va">g</span>, <span class="va">fmean</span><span class="op">)</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>이때, 아래와 같은 방법으로 이를 일정 수준 해결할 수 있다.</p>
<div class="cell">
<div class="sourceCode" id="cb99"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span> <span class="fu">fmean</span><span class="op">(</span><span class="fu">gv</span><span class="op">(</span><span class="va">DT</span>, <span class="fl">9</span><span class="op">:</span><span class="fl">13</span><span class="op">)</span>, <span class="va">DT</span><span class="op">$</span><span class="va">country</span><span class="op">)</span></span>
<span> <span class="va">g</span> <span class="op">&lt;-</span> <span class="fu">GRP</span><span class="op">(</span><span class="va">DT</span>, <span class="st">"country"</span><span class="op">)</span>; <span class="fu">add_vars</span><span class="op">(</span><span class="va">g</span><span class="op">[[</span><span class="st">"groups"</span><span class="op">]</span><span class="op">]</span>, <span class="fu">fmean</span><span class="op">(</span><span class="fu">gv</span><span class="op">(</span><span class="va">DT</span>, <span class="fl">9</span><span class="op">:</span><span class="fl">13</span><span class="op">)</span>, <span class="va">g</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb100"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">DT</span> <span class="op">&lt;-</span> <span class="fu">qDT</span><span class="op">(</span><span class="va">wlddev</span><span class="op">)</span>; <span class="va">g</span> <span class="op">&lt;-</span> <span class="fu">GRP</span><span class="op">(</span><span class="va">DT</span>, <span class="st">"country"</span><span class="op">)</span></span>
<span><span class="co">#gv: abbreviation for get_vars()</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span>a <span class="op">=</span> <span class="fu">fmean</span><span class="op">(</span><span class="fu">gv</span><span class="op">(</span><span class="va">DT</span>, <span class="fl">9</span><span class="op">:</span><span class="fl">13</span><span class="op">)</span>, <span class="va">DT</span><span class="op">$</span><span class="va">country</span><span class="op">)</span>,</span>
<span>               b0<span class="op">=</span> <span class="va">g</span> <span class="op">&lt;-</span> <span class="fu">GRP</span><span class="op">(</span><span class="va">DT</span>, <span class="st">"country"</span><span class="op">)</span>,</span>
<span>               b <span class="op">=</span> <span class="fu">add_vars</span><span class="op">(</span><span class="va">g</span><span class="op">[[</span><span class="st">"groups"</span><span class="op">]</span><span class="op">]</span>, <span class="fu">fmean</span><span class="op">(</span><span class="fu">gv</span><span class="op">(</span><span class="va">DT</span>, <span class="fl">9</span><span class="op">:</span><span class="fl">13</span><span class="op">)</span>, <span class="va">g</span><span class="op">)</span><span class="op">)</span>,</span>
<span>               dt_fmean <span class="op">=</span> <span class="va">DT</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">.SD</span>, <span class="va">fmean</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, keyby <span class="op">=</span> <span class="va">country</span>, .SDcols <span class="op">=</span> <span class="fl">9</span><span class="op">:</span><span class="fl">13</span><span class="op">]</span>,</span>
<span>               dt_gmean <span class="op">=</span> <span class="va">DT</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">.SD</span>, <span class="va">mean</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, keyby <span class="op">=</span> <span class="va">country</span>, .SDcols <span class="op">=</span> <span class="fl">9</span><span class="op">:</span><span class="fl">13</span><span class="op">]</span><span class="op">)</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Unit: microseconds
     expr      min        lq      mean   median       uq       max neval  cld
        a  358.543  378.1060  389.9855  391.505  398.437   615.572   100 a   
       b0   76.665  100.1125  107.3157  111.378  114.803   147.121   100  b  
        b  224.602  241.6375  257.6594  255.871  265.802   679.694   100 ab  
 dt_fmean 5131.574 5300.4195 5686.7481 5472.694 5572.977 12437.685   100   c 
 dt_gmean 5073.098 5293.6580 5446.3542 5399.370 5579.908  6110.983   100    d</code></pre>
</div>
</div>
<ul>
<li><p><strong>dplyr</strong>의 data %&gt;% group_by(…) %&gt;% summarize(…) 및 <strong>data.table</strong>의 [i, j, by] 구문은 데이터 그룹에 함수를 적용하기 위한 보편적인 방식이다. 이는 다양한 함수를 그룹화된 데이터에 적용하며, 특히 <strong>data.table</strong>은 몇몇 내장 함수(<strong>min, max, mean</strong> 등)를 GForce; 내부적으로 최적화하여 처리한다.</p></li>
<li><p><strong>collapse</strong>는 데이터를 그룹화하여<strong>(fgroup_by, collap)</strong> 통계 및 변환 함수를 처리한다. (by C++)</p></li>
<li><p><strong>collapse</strong>의 모든 기능(BY는 예외)은 GForce 최적화가 되어 있지만, <strong>data.table</strong> 내에서 최적화 정도의 차이, <strong>lapply</strong> 적용 상의 문제가 있는 것으로 추정된다.</p></li>
<li><p>그렇다면 <strong>fmean</strong>을 <strong>data.table</strong>내에서 쓸 수는 없을까.</p></li>
</ul>
<div class="cell">
<div class="sourceCode" id="cb102"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">DT</span><span class="op">[</span>, <span class="fu">fmean</span><span class="op">(</span><span class="va">.SD</span>, <span class="va">country</span><span class="op">)</span>, .SDcols <span class="op">=</span> <span class="fl">9</span><span class="op">:</span><span class="fl">13</span><span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>          PCGDP   LIFEEX     GINI        ODA         POP
          &lt;num&gt;    &lt;num&gt;    &lt;num&gt;      &lt;num&gt;       &lt;num&gt;
  1:   483.8351 49.19717       NA 1487548499 18362258.22
  2:  2819.2400 71.68027 31.41111  312928126  2708297.17
  3:  3532.2714 63.56290 34.36667  612238500 25305290.68
  4: 10071.0659       NA       NA         NA    43115.10
  5: 40083.0911       NA       NA         NA    51547.35
 ---                                                    
212: 35629.7336 73.71292       NA         NA    92238.53
213:  2388.4348 71.60780 34.52500 1638581462  3312289.13
214:  1069.6596 52.53707 35.46667  859950996 13741375.82
215:  1318.8627 51.09263 52.68889  734624330  8614972.38
216:  1219.4360 54.53360 45.93333  397104997  9402160.33</code></pre>
</div>
<div class="sourceCode" id="cb104"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">DT</span><span class="op">[</span>, <span class="fu">fmean</span><span class="op">(</span><span class="fu">gby</span><span class="op">(</span><span class="va">.SD</span>, <span class="va">country</span><span class="op">)</span><span class="op">)</span>, .SDcols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1L</span>, <span class="fl">9</span><span class="op">:</span><span class="fl">13</span><span class="op">)</span><span class="op">]</span> <span class="co">#gby = abbrviation for fgroup_by()</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                   country      PCGDP   LIFEEX     GINI        ODA         POP
                    &lt;char&gt;      &lt;num&gt;    &lt;num&gt;    &lt;num&gt;      &lt;num&gt;       &lt;num&gt;
  1:           Afghanistan   483.8351 49.19717       NA 1487548499 18362258.22
  2:               Albania  2819.2400 71.68027 31.41111  312928126  2708297.17
  3:               Algeria  3532.2714 63.56290 34.36667  612238500 25305290.68
  4:        American Samoa 10071.0659       NA       NA         NA    43115.10
  5:               Andorra 40083.0911       NA       NA         NA    51547.35
 ---                                                                          
212: Virgin Islands (U.S.) 35629.7336 73.71292       NA         NA    92238.53
213:    West Bank and Gaza  2388.4348 71.60780 34.52500 1638581462  3312289.13
214:           Yemen, Rep.  1069.6596 52.53707 35.46667  859950996 13741375.82
215:                Zambia  1318.8627 51.09263 52.68889  734624330  8614972.38
216:              Zimbabwe  1219.4360 54.53360 45.93333  397104997  9402160.33</code></pre>
</div>
<div class="sourceCode" id="cb106"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span>collapse        <span class="op">=</span> <span class="va">DT</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu">gby</span><span class="op">(</span><span class="va">country</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu">get_vars</span><span class="op">(</span><span class="fl">9</span><span class="op">:</span><span class="fl">13</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">fmean</span>,</span>
<span>               data.table      <span class="op">=</span> <span class="va">DT</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">.SD</span>, <span class="va">mean</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, keyby <span class="op">=</span> <span class="va">country</span>, .SDcols <span class="op">=</span> <span class="fl">9</span><span class="op">:</span><span class="fl">13</span><span class="op">]</span>,</span>
<span>               data.table_base <span class="op">=</span> <span class="va">DT</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">.SD</span>, <span class="fu">base</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, keyby <span class="op">=</span> <span class="va">country</span>, .SDcols <span class="op">=</span> <span class="fl">9</span><span class="op">:</span><span class="fl">13</span><span class="op">]</span>,</span>
<span>               hybrid_bad      <span class="op">=</span> <span class="va">DT</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">.SD</span>, <span class="va">fmean</span><span class="op">)</span>, keyby <span class="op">=</span> <span class="va">country</span>, .SDcols <span class="op">=</span> <span class="fl">9</span><span class="op">:</span><span class="fl">13</span><span class="op">]</span>,</span>
<span>               hybrid_ok       <span class="op">=</span> <span class="va">DT</span><span class="op">[</span>, <span class="fu">fmean</span><span class="op">(</span><span class="fu">gby</span><span class="op">(</span><span class="va">.SD</span>, <span class="va">country</span><span class="op">)</span><span class="op">)</span>, .SDcols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1L</span>, <span class="fl">9</span><span class="op">:</span><span class="fl">13</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Unit: microseconds
            expr      min        lq      mean   median        uq       max
        collapse  341.792  366.5840  384.8933  390.777  399.7335   501.416
      data.table 5125.348 5255.6865 5562.5321 5365.828 5636.5370 11012.503
 data.table_base 2558.182 2589.2545 2626.3920 2615.736 2638.2230  2884.591
      hybrid_bad 5166.150 5264.3745 5555.3007 5330.985 5526.0495 10046.046
       hybrid_ok  842.343  883.5925  901.0746  898.846  920.2410   995.945
 neval  cld
   100 a   
   100  b  
   100   c 
   100  b  
   100    d</code></pre>
</div>
</div>
<ul>
<li>
<strong>data.table</strong>내에서 <strong>fmean</strong> 등을 같이 쓰는 것은 <strong>바람직하지 않다.</strong>
</li>
</ul>
<pre><code>DT %&gt;% gby(country) %&gt;% get_vars(9:13) %&gt;% fmean
fmean(gv(DT, 9:13), DT$country)</code></pre>
<ul>
<li>보다 효율적인 작업을 위해 위와 같이 <strong>data.table</strong> 외에서 처리하는 방식을 사용하자.</li>
</ul>
<div class="cell">
<div class="sourceCode" id="cb109"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#fmean 이외의 예시: fsum</span></span>
<span></span>
<span><span class="co"># 국가별 ODA 합산 = 아래는 모두 동일. </span></span>
<span><span class="va">DT</span><span class="op">[</span>, <span class="va">sum_ODA</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">ODA</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, by <span class="op">=</span> <span class="va">country</span><span class="op">]</span></span>
<span><span class="va">DT</span><span class="op">[</span>, <span class="va">sum_ODA</span> <span class="op">:=</span> <span class="fu">fsum</span><span class="op">(</span><span class="va">ODA</span>, <span class="va">country</span>, TRA <span class="op">=</span> <span class="st">"replace_fill"</span><span class="op">)</span><span class="op">]</span>  </span>
<span><span class="fu">settfm</span><span class="op">(</span><span class="va">DT</span>, sum_ODA <span class="op">=</span> <span class="fu">fsum</span><span class="op">(</span><span class="va">ODA</span>, <span class="va">country</span>, TRA <span class="op">=</span> <span class="st">"replace_fill"</span><span class="op">)</span><span class="op">)</span>  <span class="co"># settfm/tfm= settransform/ftransform </span></span>
<span></span>
<span><span class="co"># 여러 열을 변경할 때 settransform이 ':=' 보다 편리하다. </span></span>
<span><span class="fu">settfm</span><span class="op">(</span><span class="va">DT</span>, perc_c_ODA <span class="op">=</span> <span class="fu">fsum</span><span class="op">(</span><span class="va">ODA</span>, <span class="va">country</span>, TRA <span class="op">=</span> <span class="st">"%"</span><span class="op">)</span>,</span>
<span>           perc_y_ODA <span class="op">=</span> <span class="fu">fsum</span><span class="op">(</span><span class="va">ODA</span>, <span class="va">year</span>, TRA <span class="op">=</span> <span class="st">"%"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span></span>
<span>  S1 <span class="op">=</span> <span class="va">DT</span><span class="op">[</span>, <span class="va">sum_ODA</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">ODA</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, by <span class="op">=</span> <span class="va">country</span><span class="op">]</span>,</span>
<span>  S2 <span class="op">=</span> <span class="va">DT</span><span class="op">[</span>, <span class="va">sum_ODA</span> <span class="op">:=</span> <span class="fu">fsum</span><span class="op">(</span><span class="va">ODA</span>, <span class="va">country</span>, TRA <span class="op">=</span> <span class="st">"replace_fill"</span><span class="op">)</span><span class="op">]</span>,</span>
<span>  S3 <span class="op">=</span> <span class="fu">settfm</span><span class="op">(</span><span class="va">DT</span>, sum_ODA <span class="op">=</span> <span class="fu">fsum</span><span class="op">(</span><span class="va">ODA</span>, <span class="va">country</span>, TRA <span class="op">=</span> <span class="st">"replace_fill"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Unit: microseconds
 expr      min        lq      mean    median        uq      max neval cld
   S1 2080.392 2157.9970 2232.1498 2242.7080 2288.3410 2563.404   100 a  
   S2  421.740  507.3445  538.3390  535.7035  578.1545  799.340   100  b 
   S3  121.292  180.0820  206.7299  201.0345  235.0795  337.004   100   c</code></pre>
</div>
</div>
<ul>
<li><p>위와 같이 <strong>data.table</strong> 외에서 처리하는 방식을 사용하자.</p></li>
<li><p>data.table에서 data 처리에 유용한 <strong>collapse</strong> 함수들:</p></li>
</ul>
<pre><code>"fcumsum()"   "fscale()"    "fbetween()"    "fwithin()"   "fhdbetween()" 
"fhdwithin()"   "flag()"    "fdiff()"       "fgrowth()"</code></pre>
<div class="cell">
<div class="sourceCode" id="cb112"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Centering GDP</span></span>
<span><span class="co">#DT[, demean_PCGDP := PCGDP - mean(PCGDP, na.rm = TRUE), by = country]</span></span>
<span><span class="va">DT</span><span class="op">[</span>, <span class="va">demean_PCGDP</span> <span class="op">:=</span> <span class="fu">fwithin</span><span class="op">(</span><span class="va">PCGDP</span>, <span class="va">country</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="fu">settfm</span><span class="op">(</span><span class="va">DT</span>, demean_PCGDP <span class="op">=</span> <span class="fu">fwithin</span><span class="op">(</span><span class="va">PCGDP</span>, <span class="va">country</span><span class="op">)</span><span class="op">)</span> <span class="co">#settfm를 사용하자.</span></span>
<span></span>
<span><span class="co"># Lagging GDP</span></span>
<span><span class="co">#DT[order(year), lag_PCGDP := shift(PCGDP, 1L), by = country]</span></span>
<span><span class="va">DT</span><span class="op">[</span>, <span class="va">lag_PCGDP</span> <span class="op">:=</span> <span class="fu">flag</span><span class="op">(</span><span class="va">PCGDP</span>, <span class="fl">1L</span>, <span class="va">country</span>, <span class="va">year</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span></span>
<span><span class="co"># Computing a growth rate</span></span>
<span><span class="co">#DT[order(year), growth_PCGDP := (PCGDP / shift(PCGDP, 1L) - 1) * 100, by = country]</span></span>
<span><span class="va">DT</span><span class="op">[</span>, <span class="va">lag_PCGDP</span> <span class="op">:=</span> <span class="fu">fgrowth</span><span class="op">(</span><span class="va">PCGDP</span>, <span class="fl">1L</span>, <span class="fl">1L</span>, <span class="va">country</span>, <span class="va">year</span><span class="op">)</span><span class="op">]</span> <span class="co"># 1 lag, 1 iteration</span></span>
<span></span>
<span><span class="co"># Several Growth rates</span></span>
<span><span class="co">#DT[order(year), paste0("growth_", .c(PCGDP, LIFEEX, GINI, ODA)) := (.SD / shift(.SD, 1L) - 1) * 100, by = country, .SDcols = 9:13]</span></span>
<span><span class="va">DT</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/compound.html">%&lt;&gt;%</a></span> <span class="fu">tfm</span><span class="op">(</span><span class="fu">gv</span><span class="op">(</span><span class="va">.</span>, <span class="fl">9</span><span class="op">:</span><span class="fl">13</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu">fgrowth</span><span class="op">(</span><span class="fl">1L</span>, <span class="fl">1L</span>, <span class="va">country</span>, <span class="va">year</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu">add_stub</span><span class="op">(</span><span class="st">"growth_"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">settfmv</span><span class="op">(</span><span class="va">DT</span>, <span class="fl">9</span><span class="op">:</span><span class="fl">13</span>, <span class="va">G</span>, <span class="fl">1L</span>, <span class="fl">1L</span>, <span class="va">country</span>, <span class="va">year</span>, apply <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span> </span>
<span><span class="va">result</span> <span class="op">&lt;-</span> <span class="va">DT</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="va">.N</span>, <span class="fl">7</span><span class="op">)</span><span class="op">]</span> <span class="op">|&gt;</span> <span class="fu">fselect</span><span class="op">(</span><span class="fl">9</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">DT</span><span class="op">)</span><span class="op">)</span>; <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">result</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       PCGDP LIFEEX  GINI        ODA       POP      sum_ODA perc_c_ODA
       &lt;num&gt;  &lt;num&gt; &lt;num&gt;      &lt;num&gt;     &lt;num&gt;        &lt;num&gt;      &lt;num&gt;
1:  598.0675 61.607    NA  161470001  48949924  29002710049  0.5567411
2: 1223.2034 55.032    NA  959559998  13115131  23032089813  4.1661873
3:        NA 43.213    NA  254979996  29248643  91042129921  0.2800681
4: 1101.9787 56.283    NA 1005000000   7086627  42753590080  2.3506798
5:        NA     NA    NA  322790009     28720   7609940052  4.2416892
6: 3931.0345 66.926    NA   88650002  26900508  30162480091  0.2939082
7:  542.0542 56.963    NA 3204889893 837468930 217402459229  1.4741737
   perc_y_ODA demean_PCGDP lag_PCGDP growth_PCGDP growth_LIFEEX growth_GINI
        &lt;num&gt;        &lt;num&gt;     &lt;num&gt;        &lt;num&gt;         &lt;num&gt;       &lt;num&gt;
1:  0.1663325   153.777583 12.674689    12.674689     0.5106536          NA
2:  1.0646265     3.767466 14.701173    14.701173     4.0381125          NA
3:  0.7028241           NA        NA           NA     0.6263972          NA
4:  1.7515717  -109.153605 -3.550449    -3.550449     1.2102140          NA
5:  0.4978978           NA        NA           NA            NA          NA
6:  0.1379507  -650.571973  1.814067     1.814067     0.7148124          NA
7:  5.5856661  -234.271909  7.299421     7.299421     0.7249836          NA
    growth_ODA growth_POP  G1.PCGDP G1.LIFEEX G1.GINI      G1.ODA     G1.POP
         &lt;num&gt;      &lt;num&gt;     &lt;num&gt;     &lt;num&gt;   &lt;num&gt;       &lt;num&gt;      &lt;num&gt;
1:  14.9498112  0.7936664 12.674689 0.5106536      NA  14.9498112  0.7936664
2:  39.2442542  1.7124987 14.701173 4.0381125      NA  39.2442542  1.7124987
3:   0.3265795  2.9335342        NA 0.6263972      NA   0.3265795  2.9335342
4: -15.8256174  3.0669073 -3.550449 1.2102140      NA -15.8256174  3.0669073
5: -16.6757024 12.6274510        NA        NA      NA -16.6757024 12.6274510
6:  -5.0246357  2.2327826  1.814067 0.7148124      NA  -5.0246357  2.2327826
7:   9.9296837  2.1699666  7.299421 0.7249836      NA   9.9296837  2.1699666</code></pre>
</div>
</div>
<ul>
<li>:= 은 data.table내에서 최적화 정도가 낮아 collapse를 이용하는 것이 대부분의 경우 더 빠르다.</li>
</ul>
<div class="cell">
<div class="sourceCode" id="cb114"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span></span>
<span>  W1 <span class="op">=</span> <span class="va">DT</span><span class="op">[</span>, <span class="va">demean_PCGDP</span> <span class="op">:=</span> <span class="va">PCGDP</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">PCGDP</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, by <span class="op">=</span> <span class="va">country</span><span class="op">]</span>,</span>
<span>  W2 <span class="op">=</span> <span class="va">DT</span><span class="op">[</span>, <span class="va">demean_PCGDP</span> <span class="op">:=</span> <span class="fu">fwithin</span><span class="op">(</span><span class="va">PCGDP</span>, <span class="va">country</span><span class="op">)</span><span class="op">]</span>,</span>
<span>  L1 <span class="op">=</span> <span class="va">DT</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="va">year</span><span class="op">)</span>, <span class="va">lag_PCGDP</span> <span class="op">:=</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/shift.html">shift</a></span><span class="op">(</span><span class="va">PCGDP</span>, <span class="fl">1L</span><span class="op">)</span>, by <span class="op">=</span> <span class="va">country</span><span class="op">]</span>,</span>
<span>  L2 <span class="op">=</span> <span class="va">DT</span><span class="op">[</span>, <span class="va">lag_PCGDP</span> <span class="op">:=</span> <span class="fu">flag</span><span class="op">(</span><span class="va">PCGDP</span>, <span class="fl">1L</span>, <span class="va">country</span>, <span class="va">year</span><span class="op">)</span><span class="op">]</span>,</span>
<span>  L3 <span class="op">=</span> <span class="va">DT</span><span class="op">[</span>, <span class="va">lag_PCGDP</span> <span class="op">:=</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/shift.html">shift</a></span><span class="op">(</span><span class="va">PCGDP</span>, <span class="fl">1L</span><span class="op">)</span>, by <span class="op">=</span> <span class="va">country</span><span class="op">]</span>, <span class="co"># Not ordered</span></span>
<span>  L4 <span class="op">=</span> <span class="va">DT</span><span class="op">[</span>, <span class="va">lag_PCGDP</span> <span class="op">:=</span> <span class="fu">flag</span><span class="op">(</span><span class="va">PCGDP</span>, <span class="fl">1L</span>, <span class="va">country</span><span class="op">)</span><span class="op">]</span> <span class="co"># Not ordered</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Unit: microseconds
 expr      min        lq      mean    median       uq       max neval    cld
   W1 1907.281 1979.7700 2213.1757 2011.0155 2070.968 10277.173   100 a     
   W2  768.293  805.5075  843.2050  840.9535  865.933  1161.758   100  b    
   L1 4107.066 4190.2105 4329.4591 4258.0900 4373.160  5072.518   100   c   
   L2 1273.071 1316.5770 1424.8645 1358.4510 1377.865  8709.820   100    d  
   L3 2591.240 2637.7440 2710.1965 2678.2500 2708.528  3347.374   100     e 
   L4  427.919  459.2580  501.5867  498.7115  518.322   879.667   100      f</code></pre>
</div>
<div class="sourceCode" id="cb116"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># flag와 같은 time series는 우선적으로 재정렬을 하지 않아 분명한 성능 차이가 존재한다. </span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb117"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">m</span> <span class="op">&lt;-</span> <span class="fu">qM</span><span class="op">(</span><span class="va">mtcars</span><span class="op">)</span></span>
<span><span class="co"># matrix to data: mrtl</span></span>
<span><span class="fu">mrtl</span><span class="op">(</span><span class="va">m</span>, names <span class="op">=</span> <span class="cn">T</span>, return <span class="op">=</span> <span class="st">"data.table"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span> <span class="co"># convert: data.table</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   Mazda RX4 Mazda RX4 Wag Datsun 710 Hornet 4 Drive Hornet Sportabout Valiant
       &lt;num&gt;         &lt;num&gt;      &lt;num&gt;          &lt;num&gt;             &lt;num&gt;   &lt;num&gt;
1:        21            21       22.8           21.4              18.7    18.1
2:         6             6        4.0            6.0               8.0     6.0
   Duster 360 Merc 240D Merc 230 Merc 280 Merc 280C Merc 450SE Merc 450SL
        &lt;num&gt;     &lt;num&gt;    &lt;num&gt;    &lt;num&gt;     &lt;num&gt;      &lt;num&gt;      &lt;num&gt;
1:       14.3      24.4     22.8     19.2      17.8       16.4       17.3
2:        8.0       4.0      4.0      6.0       6.0        8.0        8.0
   Merc 450SLC Cadillac Fleetwood Lincoln Continental Chrysler Imperial
         &lt;num&gt;              &lt;num&gt;               &lt;num&gt;             &lt;num&gt;
1:        15.2               10.4                10.4              14.7
2:         8.0                8.0                 8.0               8.0
   Fiat 128 Honda Civic Toyota Corolla Toyota Corona Dodge Challenger
      &lt;num&gt;       &lt;num&gt;          &lt;num&gt;         &lt;num&gt;            &lt;num&gt;
1:     32.4        30.4           33.9          21.5             15.5
2:      4.0         4.0            4.0           4.0              8.0
   AMC Javelin Camaro Z28 Pontiac Firebird Fiat X1-9 Porsche 914-2 Lotus Europa
         &lt;num&gt;      &lt;num&gt;            &lt;num&gt;     &lt;num&gt;         &lt;num&gt;        &lt;num&gt;
1:        15.2       13.3             19.2      27.3            26         30.4
2:         8.0        8.0              8.0       4.0             4          4.0
   Ford Pantera L Ferrari Dino Maserati Bora Volvo 142E
            &lt;num&gt;        &lt;num&gt;         &lt;num&gt;      &lt;num&gt;
1:           15.8         19.7            15       21.4
2:            8.0          6.0             8        4.0</code></pre>
</div>
</div>
<ul>
<li>fast linear model: <strong>flm</strong>
</li>
</ul>
<div class="cell">
<div class="sourceCode" id="cb119"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">wlddev</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu">fselect</span><span class="op">(</span><span class="va">country</span>, <span class="va">PCGDP</span>, <span class="va">LIFEEX</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu">na_omit</span><span class="op">(</span>cols <span class="op">=</span> <span class="op">-</span><span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>  </span>
<span>   <span class="fu">fsubset</span><span class="op">(</span><span class="fu">fnobs</span><span class="op">(</span><span class="va">PCGDP</span>, <span class="va">country</span>, <span class="st">"replace_fill"</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">20L</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">qDT</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="va">.</span><span class="op">[</span>, <span class="fu">qDT</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/lmtest/man/coeftest.html">coeftest</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="fu">G</span><span class="op">(</span><span class="va">PCGDP</span><span class="op">)</span> <span class="op">~</span> <span class="fu">G</span><span class="op">(</span><span class="va">LIFEEX</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, <span class="st">"Coef"</span><span class="op">)</span>, keyby <span class="op">=</span> <span class="va">country</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">head</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Key: &lt;country&gt;
   country        Coef   Estimate Std. Error    t value    Pr(&gt;|t|)
    &lt;char&gt;      &lt;char&gt;      &lt;num&gt;      &lt;num&gt;      &lt;num&gt;       &lt;num&gt;
1: Albania (Intercept) -3.6146411   2.371885 -1.5239527 0.136023086
2: Albania   G(LIFEEX) 22.1596308   7.288971  3.0401591 0.004325856
3: Algeria (Intercept)  0.5973329   1.740619  0.3431726 0.732731107
4: Algeria   G(LIFEEX)  0.8412547   1.689221  0.4980134 0.620390703
5:  Angola (Intercept) -3.3793976   1.540330 -2.1939445 0.034597175
6:  Angola   G(LIFEEX)  4.2362895   1.402380  3.0207852 0.004553260</code></pre>
</div>
<div class="sourceCode" id="cb121"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#절편과 변화율만 빠르게 알고싶다면 flm w/ mrtl: (no standard errors)</span></span>
<span><span class="va">wlddev</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu">fselect</span><span class="op">(</span><span class="va">country</span>, <span class="va">PCGDP</span>, <span class="va">LIFEEX</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu">na_omit</span><span class="op">(</span>cols <span class="op">=</span> <span class="op">-</span><span class="fl">1L</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">fsubset</span><span class="op">(</span><span class="fu">fnobs</span><span class="op">(</span><span class="va">PCGDP</span>, <span class="va">country</span>, <span class="st">"replace_fill"</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">20L</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">qDT</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="va">.</span><span class="op">[</span>, <span class="fu">mrtl</span><span class="op">(</span><span class="fu">flm</span><span class="op">(</span><span class="fu">fgrowth</span><span class="op">(</span><span class="va">PCGDP</span><span class="op">)</span><span class="op">[</span><span class="op">-</span><span class="fl">1L</span><span class="op">]</span>, </span>
<span>               <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span>Intercept <span class="op">=</span> <span class="fl">1</span>, LIFEEX <span class="op">=</span> <span class="fu">fgrowth</span><span class="op">(</span><span class="va">LIFEEX</span><span class="op">)</span><span class="op">[</span><span class="op">-</span><span class="fl">1L</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>, <span class="cn">TRUE</span><span class="op">)</span>, keyby <span class="op">=</span> <span class="va">country</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">head</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Key: &lt;country&gt;
               country   Intercept     LIFEEX
                &lt;char&gt;       &lt;num&gt;      &lt;num&gt;
1:             Albania -3.61464113 22.1596308
2:             Algeria  0.59733291  0.8412547
3:              Angola -3.37939760  4.2362895
4: Antigua and Barbuda -3.11880717 18.8700870
5:           Argentina  1.14613567 -0.2896305
6:             Armenia  0.08178344 11.5523992</code></pre>
</div>
<div class="sourceCode" id="cb123"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op">(</span></span>
<span>  A<span class="op">=</span> <span class="va">wlddev</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu">fselect</span><span class="op">(</span><span class="va">country</span>, <span class="va">PCGDP</span>, <span class="va">LIFEEX</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu">na_omit</span><span class="op">(</span>cols <span class="op">=</span> <span class="op">-</span><span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>  </span>
<span>   <span class="fu">fsubset</span><span class="op">(</span><span class="fu">fnobs</span><span class="op">(</span><span class="va">PCGDP</span>, <span class="va">country</span>, <span class="st">"replace_fill"</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">20L</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">qDT</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="va">.</span><span class="op">[</span>, <span class="fu">qDT</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/lmtest/man/coeftest.html">coeftest</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="fu">G</span><span class="op">(</span><span class="va">PCGDP</span><span class="op">)</span> <span class="op">~</span> <span class="fu">G</span><span class="op">(</span><span class="va">LIFEEX</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, <span class="st">"Coef"</span><span class="op">)</span>, keyby <span class="op">=</span> <span class="va">country</span><span class="op">]</span> ,</span>
<span>  </span>
<span>  B<span class="op">=</span> <span class="va">wlddev</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu">fselect</span><span class="op">(</span><span class="va">country</span>, <span class="va">PCGDP</span>, <span class="va">LIFEEX</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu">na_omit</span><span class="op">(</span>cols <span class="op">=</span> <span class="op">-</span><span class="fl">1L</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>   <span class="fu">fsubset</span><span class="op">(</span><span class="fu">fnobs</span><span class="op">(</span><span class="va">PCGDP</span>, <span class="va">country</span>, <span class="st">"replace_fill"</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">20L</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">qDT</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="va">.</span><span class="op">[</span>, <span class="fu">mrtl</span><span class="op">(</span><span class="fu">flm</span><span class="op">(</span><span class="fu">fgrowth</span><span class="op">(</span><span class="va">PCGDP</span><span class="op">)</span><span class="op">[</span><span class="op">-</span><span class="fl">1L</span><span class="op">]</span>, </span>
<span>               <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span>Intercept <span class="op">=</span> <span class="fl">1</span>, LIFEEX <span class="op">=</span> <span class="fu">fgrowth</span><span class="op">(</span><span class="va">LIFEEX</span><span class="op">)</span><span class="op">[</span><span class="op">-</span><span class="fl">1L</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>, <span class="cn">TRUE</span><span class="op">)</span>, keyby <span class="op">=</span> <span class="va">country</span><span class="op">]</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Unit: milliseconds
 expr        min         lq       mean     median        uq       max neval cld
    A 166.570912 167.508276 172.559989 168.680762 172.24341 344.73358   100  a 
    B   7.115262   7.422762   7.813804   7.526314   7.61188  13.21533   100   b</code></pre>
</div>
<div class="sourceCode" id="cb125"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># coeftest + lm + G 를 flm + fgrowth와 같은 collapse식으로 대체하여 큰 속도 이득을 볼 수 있다.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>
<strong>collapse</strong> w/ list; <strong>rsplit; rapply2d; get_elem; unlist2d</strong>
</li>
</ul>
<p><strong>rapply2d()</strong>: <strong>data.table/frame</strong>에 function 적용.</p>
<div class="cell">
<div class="sourceCode" id="cb126"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">lm_summary_list</span> <span class="op">&lt;-</span> <span class="va">DT_list</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">rapply2d</span><span class="op">(</span><span class="va">lm</span>, formula <span class="op">=</span> <span class="fu">G</span><span class="op">(</span><span class="va">PCGDP</span><span class="op">)</span> <span class="op">~</span> <span class="fu">G</span><span class="op">(</span><span class="va">LIFEEX</span><span class="op">)</span> <span class="op">+</span> <span class="fu">B</span><span class="op">(</span><span class="fu">G</span><span class="op">(</span><span class="va">LIFEEX</span><span class="op">)</span>, <span class="va">country</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">rapply2d</span><span class="op">(</span><span class="va">summary</span>, classes <span class="op">=</span> <span class="st">"lm"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>get_elem()</strong>: 원하는 부분을 추출, 이후 <strong>unlist2d</strong>를 이용해 <strong>data.table</strong>로 만들 수 있다.</p>
<div class="cell">
<div class="sourceCode" id="cb127"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span> <span class="va">lm_summary_list</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">get_elem</span><span class="op">(</span><span class="st">"coefficients"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">unlist2d</span><span class="op">(</span>idcols <span class="op">=</span> <span class="fu">.c</span><span class="op">(</span><span class="va">Region</span>, <span class="va">Income</span><span class="op">)</span>, row.names <span class="op">=</span> <span class="st">"Coef"</span>, DT <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">head</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                Region              Income                  Coef  Estimate
                &lt;char&gt;              &lt;char&gt;                &lt;char&gt;     &lt;num&gt;
1: East Asia &amp; Pacific         High income           (Intercept) 0.5313479
2: East Asia &amp; Pacific         High income             G(LIFEEX) 2.4935584
3: East Asia &amp; Pacific         High income B(G(LIFEEX), country) 3.8297123
4: East Asia &amp; Pacific Lower middle income           (Intercept) 1.3476602
5: East Asia &amp; Pacific Lower middle income             G(LIFEEX) 0.5238856
6: East Asia &amp; Pacific Lower middle income B(G(LIFEEX), country) 0.9494439
   Std. Error   t value    Pr(&gt;|t|)
        &lt;num&gt;     &lt;num&gt;       &lt;num&gt;
1:  0.7058550 0.7527720 0.451991327
2:  0.7586943 3.2866443 0.001095466
3:  1.6916770 2.2638554 0.024071386
4:  0.7008556 1.9228785 0.055015131
5:  0.7574904 0.6916069 0.489478164
6:  1.2031228 0.7891496 0.430367103</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode" id="cb129"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># 물론, 이렇게도 할 수 있다. </span></span>
<span><span class="va">DT</span><span class="op">[</span>, <span class="fu">qDT</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/lmtest/man/coeftest.html">coeftest</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="fu">G</span><span class="op">(</span><span class="va">PCGDP</span><span class="op">)</span> <span class="op">~</span> <span class="fu">G</span><span class="op">(</span><span class="va">LIFEEX</span><span class="op">)</span> <span class="op">+</span> <span class="fu">B</span><span class="op">(</span><span class="fu">G</span><span class="op">(</span><span class="va">LIFEEX</span><span class="op">)</span>, <span class="va">country</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, <span class="st">"Coef"</span><span class="op">)</span>, </span>
<span>   keyby <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">region</span>, <span class="va">income</span><span class="op">)</span><span class="op">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="summary" class="level1"><h1>Summary</h1>
<ol type="1">
<li><p><strong>collapse</strong>는 빠르며, data/memory 측면에서 경제적이다.</p></li>
<li><p><strong>vector, matrix, data.table</strong> 등 데이터 형식에 구애받지 않고 사용가능하다.</p></li>
<li><p>(<strong>dplyr, tidyverse, data.table</strong> 등) 기존 <strong>framework</strong>와 통합하여 사용 가능하다.</p></li>
<li><p><strong>data.table</strong>과 혼용하여 쓸 경우, <strong>dt[]</strong> 내부에서 사용하면 성능이 저하된다. 이는 내부적 데이터 처리 과정의 차이에서 기인한다.</p></li>
<li><p><strong>data.table</strong> 형식을 처리할 때는, <strong>아래</strong>와 같은 문법으로 사용해야 이의 효과를 기대할 수 있다.</p></li>
</ol>
<pre><code>권장되지 않음:
&gt;   DT[order(year), paste0("growth_", .c(PCGDP, LIFEEX, GINI, ODA)) := (.SD / shift(.SD, 1L) - 1) * 100, 
          by = country, .SDcols = 9:13]
권장됨
&gt;&gt;    DT %&lt;&gt;% tfm(gv(., 9:13) %&gt;% fgrowth(1L, 1L, country, year) %&gt;% add_stub("growth_"))
&gt;&gt;    settfmv(DT, 9:13, G, 1L, 1L, country, year, apply = FALSE)</code></pre>


</section><div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-reuse"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div class="quarto-appendix-contents"><div><a rel="license" href="https://creativecommons.org/licenses/by-nc/4.0/">CC BY-NC 4.0</a></div></div></section><section class="quarto-appendix-contents" id="quarto-citation"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{lee2024,
  author = {LEE, Hojun},
  title = {Collapse {패키지} {소개} V2},
  date = {2024-10-29},
  url = {https://blog.zarathu.com/posts/2024-10-28-Collapse/},
  langid = {en}
}
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-lee2024" class="csl-entry quarto-appendix-citeas" role="listitem">
LEE, Hojun. 2024. <span>“Collapse 패키지 소개 V2.”</span> October 29,
2024. <a href="https://blog.zarathu.com/posts/2024-10-28-Collapse/">https://blog.zarathu.com/posts/2024-10-28-Collapse/</a>.
</div></div></section></div></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/blog\.zarathu\.com");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><script src="https://giscus.app/client.js" data-repo="zarathucorp/giscus-blog" data-repo-id="R_kgDOHztuxg" data-category="General" data-category-id="DIC_kwDOHztuxs4CQ6h5" data-mapping="title" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="light" data-lang="en" crossorigin="anonymous" async="">
</script><input type="hidden" id="giscus-base-theme" value="light"><input type="hidden" id="giscus-alt-theme" value="dark">
</div> <!-- /content -->
<footer class="footer"><div class="nav-footer">
    <div class="nav-footer-left">
<p>Powered by <a href="https://quarto.org">Quarto</a>.</p>
</div>   
    <div class="nav-footer-center">
<p>© 2019. <a href="https://www.zarathu.com">Zarathu Co.,Ltd.</a> All rights reserved. Licence: <a href="https://opensource.org/license/mit-0/">MIT</a>.</p>
</div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>


<script src="../../site_libs/quarto-html/zenscroll-min.js"></script>
</body></html>